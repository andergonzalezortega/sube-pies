<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1b2838">
<title>Sube Pies</title>
<link rel="manifest" href="data:application/json,{}">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<style>
:root{--bg:#141e2b;--bg2:#1b2838;--bg3:#243447;--bg4:#2d4055;--rock:#d4a574;--rockD:#8b6842;--green:#4ecdc4;--greenD:#2ea89f;--red:#ff6b6b;--yellow:#ffe66d;--blue:#4a9eff;--purple:#a78bfa;--text:#e8e0d8;--text2:#8a9bb0;--text3:#5a6a7a;--R:16px;}
*{margin:0;padding:0;box-sizing:border-box;}body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;padding-bottom:75px;}
h1,h2,h3{font-family:'Bebas Neue',sans-serif;letter-spacing:1.5px;}
body::before{content:'';position:fixed;top:0;left:0;right:0;height:200px;background:linear-gradient(180deg,#1e3045,#1b2838 60%,var(--bg));z-index:-1;opacity:.7;}
.nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg2);border-top:1px solid rgba(255,255,255,.05);display:flex;z-index:100;backdrop-filter:blur(20px);padding-bottom:env(safe-area-inset-bottom);}
.nb{flex:1;padding:8px 0 6px;text-align:center;color:var(--text3);font-size:9px;cursor:pointer;border:none;background:none;font-family:'Nunito';transition:.2s;}.nb.on{color:var(--rock);}.nb svg{display:block;margin:0 auto 2px;width:20px;height:20px;}.nb.on svg{filter:drop-shadow(0 0 5px rgba(212,165,116,.4));}
.page{display:none;padding:16px;animation:fu .3s ease;}.page.on{display:block;}#ph.on{display:flex!important;flex-direction:column;}@keyframes fu{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
.hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}.hdr h1{font-size:24px;color:var(--rock);}
.card{background:var(--bg2);border-radius:var(--R);padding:14px;border:1px solid rgba(255,255,255,.04);margin-bottom:12px;}.ct{font-family:'Bebas Neue';font-size:14px;color:var(--text2);letter-spacing:2px;margin-bottom:10px;}
.stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px;}.st{background:var(--bg2);border-radius:12px;padding:10px 8px;text-align:center;border:1px solid rgba(255,255,255,.04);}.st .v{font-family:'Bebas Neue';font-size:28px;line-height:1;}.st .l{font-size:9px;color:var(--text2);margin-top:2px;}.st.a .v{color:var(--rock);}.st.b .v{color:var(--green);}.st.c .v{color:var(--yellow);}
.cn{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}.cn button{background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer;padding:4px 10px;}.cn .mo{font-family:'Bebas Neue';font-size:18px;color:var(--text);}
.cg{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;}.cdh{text-align:center;font-size:9px;color:var(--text3);padding:2px 0;}
.cd{text-align:center;padding:4px 2px;border-radius:6px;font-size:11px;cursor:pointer;color:var(--text3);font-weight:400;}
.cd:hover{background:var(--bg3);}.cd.tod{outline:2px solid var(--text2);outline-offset:-2px;}
.cd.hr{color:var(--rock);font-weight:700;}.cd.hc{color:var(--green);font-weight:700;}
.cd.hb{background:linear-gradient(135deg,var(--rock),var(--green));color:#000;font-weight:700;}
.cd.ht{text-decoration:underline;text-decoration-color:var(--yellow);text-underline-offset:3px;}
.cd.plan{border:1.5px dashed var(--blue);color:var(--blue);}.cd.hw{border:1.5px dashed var(--purple);}
.cd.sel{background:var(--rock)!important;color:#000!important;font-weight:700;}.cd.emp{cursor:default;}
.gsw{display:flex;gap:0;margin-bottom:10px;background:var(--bg3);border-radius:8px;padding:2px;flex-wrap:wrap;}
.gs{flex:1;padding:5px 2px;text-align:center;border-radius:6px;font-size:10px;cursor:pointer;color:var(--text2);border:none;background:none;font-family:'Nunito';min-width:0;}.gs.on{background:var(--rock);color:#000;font-weight:700;}
.gp{flex:1;padding:5px 2px;text-align:center;border-radius:6px;font-size:10px;cursor:pointer;color:var(--text2);border:none;background:none;font-family:'Nunito';min-width:0;}.gp.on{background:var(--blue);color:#fff;font-weight:700;}
.gb{display:flex;flex-direction:column;gap:5px;}.gr{display:flex;align-items:center;gap:6px;}.grn{font-family:'Bebas Neue';font-size:14px;width:32px;text-align:right;color:var(--text2);}.grb{flex:1;height:18px;background:var(--bg3);border-radius:9px;overflow:hidden;}.grf{height:100%;border-radius:9px;display:flex;align-items:center;padding-left:6px;font-size:10px;font-weight:700;min-width:20px;}.grf.rc{background:linear-gradient(90deg,var(--rockD),var(--rock));}.grf.ro{background:linear-gradient(90deg,var(--greenD),var(--green));color:#000;}
.via{background:var(--bg2);border-radius:var(--R);padding:12px;margin-bottom:8px;border:1px solid rgba(255,255,255,.04);cursor:pointer;}.via:active{transform:scale(.98);}.via.enc .vg{color:var(--green);}.vt{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}.vg{font-family:'Bebas Neue';font-size:22px;color:var(--rock);}.vd{font-size:11px;color:var(--text3);}.vn{font-size:13px;font-weight:600;margin-bottom:3px;}.vl{font-size:11px;color:var(--text2);margin-bottom:5px;}.vts{display:flex;flex-wrap:wrap;gap:3px;}.tg{display:inline-block;padding:2px 7px;border-radius:6px;font-size:9px;background:var(--bg3);color:var(--text2);}.tg.e{background:rgba(78,205,196,.15);color:var(--green);}.tg.r{background:rgba(212,165,116,.15);color:var(--rock);}.tg.t{background:rgba(74,158,255,.15);color:var(--blue);}
.trn{background:var(--bg2);border-radius:var(--R);padding:12px;margin-bottom:8px;border-left:3px solid var(--yellow);border:1px solid rgba(255,255,255,.04);}.tt2{font-family:'Bebas Neue';font-size:18px;color:var(--yellow);}.td{font-size:12px;color:var(--text2);margin-top:4px;}
#mapDiv{height:350px;border-radius:var(--R);overflow:hidden;margin-bottom:12px;border:1px solid rgba(255,255,255,.04);}
.map-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;}
.map-search{display:flex;gap:6px;margin-bottom:12px;}.map-search input{flex:1;background:var(--bg3);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px 12px;color:var(--text);font-size:13px;font-family:'Nunito';outline:none;}.map-search input:focus{border-color:var(--rock);}
.mbg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);}.mbg.sh{display:flex;}.mdl{background:var(--bg2);border-radius:20px 20px 0 0;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;padding:20px;animation:su .3s ease;}@keyframes su{from{transform:translateY(100%)}to{transform:none}}.mdl h2{font-size:22px;color:var(--rock);margin-bottom:16px;}.mx{float:right;background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer;}
.fl{margin-bottom:12px;}.fl label{display:block;font-size:11px;color:var(--text2);margin-bottom:3px;font-weight:600;}.fl input,.fl textarea,.fl select{width:100%;background:var(--bg3);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:9px 11px;color:var(--text);font-size:13px;font-family:'Nunito';outline:none;}.fl input:focus,.fl textarea:focus,.fl select:focus{border-color:var(--rock);}.fl textarea{resize:vertical;min-height:50px;}
.fl small{font-size:10px;color:var(--text3);margin-top:2px;display:block;}
.btn{width:100%;padding:11px;border:none;border-radius:12px;font-size:14px;font-family:'Nunito';font-weight:700;cursor:pointer;}.bp{background:var(--rock);color:#000;}.bp:active{transform:scale(.97);}.bg2{background:none;border:1px solid var(--text3);color:var(--text2);margin-top:8px;}.bdel{background:var(--red);color:#fff;margin-top:8px;}
.chs{display:flex;gap:5px;margin-bottom:12px;overflow-x:auto;padding-bottom:4px;}.ch{white-space:nowrap;padding:4px 10px;border-radius:14px;font-size:10px;cursor:pointer;border:1px solid rgba(255,255,255,.08);background:var(--bg2);color:var(--text2);font-family:'Nunito';}.ch.on{background:var(--rock);color:#000;border-color:var(--rock);}
.tbs{display:flex;gap:0;margin-bottom:12px;background:var(--bg3);border-radius:10px;padding:2px;}.tb{flex:1;padding:6px;text-align:center;border-radius:8px;font-size:11px;cursor:pointer;color:var(--text2);border:none;background:none;font-family:'Nunito';}.tb.on{background:var(--rock);color:#000;font-weight:700;}
.sb{display:flex;align-items:center;gap:6px;margin-bottom:10px;}.sb label{font-size:10px;color:var(--text3);}.sb select{background:var(--bg3);border:1px solid rgba(255,255,255,.08);color:var(--text);font-size:11px;padding:4px 7px;border-radius:8px;font-family:'Nunito';outline:none;}
.eg{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;}.eb{padding:8px;text-align:center;background:var(--bg3);border:1px solid rgba(255,255,255,.08);border-radius:10px;cursor:pointer;font-size:11px;color:var(--text2);font-family:'Nunito';}.eb.on{border-color:var(--rock);color:var(--rock);background:rgba(212,165,116,.1);}.eb .ic{font-size:18px;margin-bottom:3px;}
.ep{display:grid;grid-template-columns:1fr 1fr;gap:6px;}.ep .fl{margin-bottom:6px;}.ep input,.ep select{padding:7px 9px;font-size:12px;}
.ws{background:var(--bg3);border-radius:10px;padding:8px 10px;margin-bottom:5px;display:flex;align-items:center;gap:6px;}.ws .wn{font-family:'Bebas Neue';font-size:16px;color:var(--rock);min-width:18px;}.ws .wd{flex:1;font-size:11px;}.ws .wr{background:none;border:none;color:var(--red);font-size:14px;cursor:pointer;}
.wi{background:var(--bg2);border-radius:var(--R);padding:12px;margin-bottom:8px;border:1px solid rgba(255,255,255,.04);position:relative;}.wit{font-family:'Bebas Neue';font-size:16px;color:var(--purple);}.wis{font-size:11px;color:var(--text2);margin-top:5px;}.wiss{padding:2px 0;border-bottom:1px solid rgba(255,255,255,.03);}.wib{margin-top:8px;padding:7px 12px;background:var(--bg3);border:1px solid var(--purple);border-radius:8px;color:var(--purple);font-size:11px;cursor:pointer;font-family:'Nunito';display:inline-block;margin-right:4px;}
.wi-del{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--red);font-size:16px;cursor:pointer;}
.wi-date{font-size:10px;color:var(--blue);margin-top:4px;}
.sbb{background:var(--rock);color:#000;border:none;padding:12px 28px;border-radius:25px;font-size:14px;cursor:pointer;font-family:'Nunito';font-weight:700;}.sbb:active{transform:scale(.95);}.sbb.ok{background:var(--green);}
#loginPage{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;text-align:center;}
.login-logo{font-family:'Bebas Neue';font-size:48px;color:var(--rock);margin-bottom:4px;}
.goog-btn{display:flex;align-items:center;gap:12px;background:#fff;color:#333;border:none;padding:14px 28px;border-radius:25px;font-size:15px;font-family:'Nunito';font-weight:700;cursor:pointer;}.goog-btn:active{transform:scale(.95);}.goog-btn img{width:20px;height:20px;}
.usr-bar{display:flex;align-items:center;gap:6px;padding:4px 0;}.usr-pic{width:24px;height:24px;border-radius:50%;border:2px solid var(--rock);}.usr-name{font-size:11px;color:var(--text2);}.usr-out{background:none;border:none;color:var(--text3);font-size:9px;cursor:pointer;text-decoration:underline;}
.fr-card{display:flex;align-items:center;gap:8px;background:var(--bg3);border-radius:10px;padding:8px;margin-bottom:5px;cursor:pointer;}.fr-pic{width:32px;height:32px;border-radius:50%;border:2px solid var(--rock);}.fr-info{flex:1;}.fr-name{font-size:13px;font-weight:600;}.fr-email{font-size:9px;color:var(--text3);}.fr-rm{background:none;border:none;color:var(--red);font-size:14px;cursor:pointer;}
.spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--text3);border-top-color:var(--rock);border-radius:50%;animation:spin .6s linear infinite;}@keyframes spin{to{transform:rotate(360deg)}}.load-full{display:flex;align-items:center;justify-content:center;min-height:100vh;}
.leaflet-popup-content-wrapper{background:var(--bg2)!important;color:var(--text)!important;border-radius:12px!important;border:1px solid var(--rock)!important;}.leaflet-popup-tip{background:var(--bg2)!important;}.leaflet-popup-content{font-family:'Nunito'!important;font-size:12px!important;}
</style>
</head>
<body>
<div id="loadPage" class="load-full"><div class="spinner" style="width:40px;height:40px;border-width:3px"></div></div>
<div id="loginPage" style="display:none"><div style="font-size:60px;margin-bottom:10px">‚õ∞Ô∏è</div><div class="login-logo">SUBE PIES</div><div style="color:var(--text2);font-size:14px;margin-bottom:30px">Diario de escalada</div><button class="goog-btn" onclick="loginGoogle()"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg">Entrar con Google</button></div>
<div id="appWrap" style="display:none">
<!-- HOME --><div id="ph" class="page on" style="overflow:hidden;height:calc(100vh - 75px);display:none">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px"><div><h1 style="font-size:22px;color:var(--rock);margin:0">SUBE PIES</h1><div class="usr-bar"><img class="usr-pic" id="uPic"><span class="usr-name" id="uName"></span><button class="usr-out" onclick="logout()">Salir</button></div></div><button class="sbb" style="font-size:10px;padding:5px 10px" onclick="go('sync')">üì°</button></div>
<div class="gsw" id="sPer" style="margin-bottom:4px"></div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:6px"><div class="st a" style="padding:6px 4px"><div class="v" id="sV" style="font-size:24px">0</div><div class="l" id="sVl">V√≠as / a√±o</div></div><div class="st b" style="padding:6px 4px"><div class="v" id="sE" style="font-size:24px">0</div><div class="l" id="sEl">Enc</div></div><div class="st c" style="padding:6px 4px"><div class="v" id="sT" style="font-size:24px">0</div><div class="l" id="sTl">Entrenos</div></div></div>
<div style="background:var(--bg2);border-radius:12px;padding:8px;border:1px solid rgba(255,255,255,.04);margin-bottom:6px"><div class="cn" style="margin-bottom:4px"><button onclick="cNav(-1)" style="padding:2px 6px;font-size:16px">‚óÄ</button><span class="mo" id="cM" style="font-size:15px"></span><button onclick="cNav(1)" style="padding:2px 6px;font-size:16px">‚ñ∂</button></div><div class="cg" id="cG"></div><div id="cD" style="margin-top:4px"></div></div>
<div style="background:var(--bg2);border-radius:12px;padding:8px;border:1px solid rgba(255,255,255,.04);overflow-y:auto;flex:1"><div style="display:flex;align-items:center;gap:6px;margin-bottom:4px"><span class="ct" style="margin:0;font-size:12px">GRADOS</span></div><div class="gsw" id="gPer" style="margin-bottom:4px"></div><div class="gsw" id="gS" style="margin-bottom:4px"></div><div class="gb" id="gB"></div></div>
</div>
<!-- V√çAS --><div id="pv" class="page"><div class="hdr"><h1>V√çAS</h1><button class="bp btn" style="width:auto;padding:6px 12px;font-size:11px;border-radius:10px" onclick="addR()">+ A√±adir</button></div><div class="chs" id="rF"></div><div class="sb"><label>Ordenar:</label><select id="rS" onchange="drR()"><option value="date">Fecha ‚Üì</option><option value="dateA">Fecha ‚Üë</option><option value="grD">Grado ‚Üì</option><option value="grA">Grado ‚Üë</option><option value="lugar">Lugar</option><option value="amigo">Compa√±ero</option></select></div><div id="rL"></div></div>
<!-- MAPA --><div id="pm" class="page"><div class="hdr"><h1>MAPA ‚Äî ROCA</h1></div><div class="map-stats"><div class="st a"><div class="v" id="mTotal">0</div><div class="l">Total v√≠as</div></div><div class="st b"><div class="v" id="mEnc">0</div><div class="l">Encadenadas</div></div><div class="st"><div class="v" style="color:var(--blue)" id="mZonas">0</div><div class="l">Zonas</div></div></div><div class="map-search"><input id="mapQ" placeholder="üîç Buscar zona..." oninput="filterMap()"><button class="bp btn" style="width:auto;padding:8px 12px;font-size:11px;border-radius:10px" onclick="openNewCrag()">+ Zona</button></div><div id="mapDiv"></div><div id="mapResults" style="display:none"></div><div id="mRt"></div></div>
<!-- ENTRENOS --><div id="pt" class="page"><div class="hdr"><h1>ENTRENOS</h1></div><div class="tbs" id="tT"></div><div id="tH"></div><div id="tP" style="display:none"><button class="btn bp" onclick="openWo()" style="margin-bottom:12px">+ Crear entreno</button><div id="wL"></div></div></div>
<!-- AMIGOS --><div id="pf" class="page"><div class="hdr"><h1>AMIGOS</h1></div><div class="card"><div class="ct">A√ëADIR AMIGO</div><div style="display:flex;gap:6px"><input id="frEmail" placeholder="Email del amigo" style="flex:1;background:var(--bg3);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px;color:var(--text);font-size:12px;font-family:Nunito;outline:none"><button class="bp btn" style="width:auto;padding:8px 14px;font-size:12px;border-radius:10px" onclick="addFriend()">+</button></div><div id="frMsg" style="font-size:10px;margin-top:4px"></div></div><div class="ct" style="margin-top:12px">MIS AMIGOS</div><div id="frList"></div><div id="frView" style="display:none;margin-top:12px"><div class="ct" id="frViewTitle"></div><div id="frRoutes"></div></div></div>
<!-- SYNC --><div id="ps" class="page"><div class="hdr"><h1>SYNC</h1></div><div class="card" style="text-align:center;padding:20px"><div style="font-size:48px;margin-bottom:8px">‚õ∞Ô∏è</div><div style="font-size:13px;color:var(--text2);margin-bottom:12px" id="bT">Conecta tu ESP32</div><button class="sbb" id="bB" onclick="doBT()">Conectar ESP32</button></div>
<div class="card"><div class="ct">EXPORTAR A EXCEL</div>
<div style="display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap" id="exPer"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px"><div class="fl" style="margin:0"><label>Desde</label><input type="date" id="exFrom"></div><div class="fl" style="margin:0"><label>Hasta</label><input type="date" id="exTo"></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><button class="btn bp" style="font-size:12px;padding:10px" onclick="exportXL('vias')">üì• V√≠as</button><button class="btn bp" style="font-size:12px;padding:10px;background:var(--yellow);color:#000" onclick="exportXL('entrenos')">üì• Entrenos</button></div>
<div id="exMsg" style="font-size:10px;margin-top:6px;text-align:center"></div>
</div>
<div class="card"><div class="ct">DATOS EN LA NUBE</div><p style="font-size:12px;color:var(--text2)"><span style="font-family:'Bebas Neue';font-size:22px;color:var(--green)" id="sN">0</span> registros guardados</p><p style="font-size:10px;color:var(--text3);margin-top:4px">Tus datos est√°n seguros en Firebase.</p></div></div>
</div>
<!-- MODAL ROUTE --><div class="mbg" id="mR1"><div class="mdl"><button class="mx" onclick="cm('mR1')">‚úï</button><h2 id="mRT">V√çA</h2><div class="fl"><label>Nombre</label><input id="iN" placeholder="Diedro m√°gico"></div><div class="fl"><label>Lugar</label><input id="iL" placeholder="Atauri, Galdames..." list="dlZ"><datalist id="dlZ"></datalist></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div class="fl"><label>Tipo lugar</label><select id="iLT"><option value="roca">Roca</option><option value="roco">Roc√≥dromo</option></select></div><div class="fl"><label>Tipo v√≠a</label><select id="iTP"><option>Cuerda</option><option>Bloque</option><option>AutoAseg</option><option>Largos</option></select></div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px"><div class="fl"><label>Grado</label><select id="iG"></select></div><div class="fl"><label>Intento</label><select id="iI"></select></div><div class="fl"><label>Encadenado</label><select id="iE"><option value="1">S√≠</option><option value="0">No</option></select></div></div><div class="fl"><label>Sensaciones</label><textarea id="iNo" placeholder="Beta, condiciones..."></textarea></div><div class="fl"><label>Compa√±eros</label><input id="iA" placeholder="Mikel, Ane, Jon"></div><div class="fl"><label>Fecha</label><input type="date" id="iFe"></div><button class="btn bp" onclick="svR()">Guardar</button><button class="btn bdel" id="btnDelR" style="display:none" onclick="delR()">üóëÔ∏è Eliminar v√≠a</button><button class="btn bg2" onclick="cm('mR1')">Cancelar</button></div></div>
<!-- MODAL WORKOUT --><div class="mbg" id="mW1"><div class="mdl"><button class="mx" onclick="cm('mW1')">‚úï</button><h2>CREAR ENTRENO</h2><div class="fl"><label>Nombre</label><input id="wNm" placeholder="Fuerza dedos"></div><div class="fl"><label>Fecha programada (opcional)</label><input type="date" id="wDt"></div><div class="ct">PASOS</div><div id="wS"></div><div class="ct" style="margin-top:12px">A√ëADIR EJERCICIO</div><div class="eg" id="eG"></div><div id="eP" style="display:none"></div><button class="btn bg2" id="eA" style="display:none;margin-bottom:12px" onclick="addEj()">+ A√±adir</button><hr style="border:none;border-top:1px solid var(--bg4);margin:12px 0"><button class="btn bp" onclick="svW()">Guardar</button><button class="btn bg2" onclick="cm('mW1')">Cancelar</button></div></div>
<!-- MODAL PLAN --><div class="mbg" id="mPl"><div class="mdl"><button class="mx" onclick="cm('mPl')">‚úï</button><h2>PLANIFICAR D√çA</h2><div class="fl"><label>Fecha</label><input type="date" id="plDt"></div><div class="fl"><label>Lugar</label><input id="plLg" placeholder="Atauri" list="dlZ"></div><div class="fl"><label>Tipo</label><select id="plTp"><option value="roca">Roca</option><option value="roco">Roc√≥dromo</option></select></div><div class="fl"><label>Notas</label><input id="plNo" placeholder="Plan del d√≠a..."></div><button class="btn bp" onclick="svPlan()">Guardar</button><button class="btn bg2" onclick="cm('mPl')">Cancelar</button></div></div>
<!-- MODAL NEW CRAG --><div class="mbg" id="mNC"><div class="mdl"><button class="mx" onclick="cm('mNC')">‚úï</button><h2>NUEVA ZONA</h2><p style="font-size:12px;color:var(--text2);margin-bottom:12px">En Google Maps ‚Üí busca el sitio ‚Üí pulsa largo ‚Üí copia las coordenadas que aparecen abajo (ej: 43.270854, -3.102539).</p><div class="fl"><label>Nombre de la zona</label><input id="ncNm" placeholder="Galdames"></div><div class="fl"><label>Coordenadas</label><input id="ncCoords" placeholder="43.270854, -3.102539"><small>Pega las coordenadas o la URL larga de Google Maps (la que tiene @43.27,-3.10)</small></div><div id="ncMsg" style="font-size:11px;margin-bottom:8px"></div><button class="btn bp" onclick="svNewCrag()">Guardar zona</button><button class="btn bg2" onclick="cm('mNC')">Cancelar</button></div></div>
<!-- NAV --><nav class="nav">
<button class="nb on" onclick="go('home')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l9-9 9 9M5 10v10a1 1 0 001 1h3m10-11v10a1 1 0 01-1 1h-3m-4 0v-6"/></svg>Inicio</button>
<button class="nb" onclick="go('routes')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>V√≠as</button>
<button class="nb" onclick="go('map')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>Mapa</button>
<button class="nb" onclick="go('train')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>Entrenos</button>
<button class="nb" onclick="go('friends')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>Amigos</button>
<button class="nb" onclick="go('sync')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 7h12l-4-4M16 17H4l4 4"/></svg>Sync</button>
</nav>
<script>
firebase.initializeApp({apiKey:"AIzaSyBaBnTmI8_YuYIRGx2mdDVJSe_k4SF_eho",authDomain:"sube-pies.firebaseapp.com",projectId:"sube-pies",storageBucket:"sube-pies.firebasestorage.app",messagingSenderId:"597414564277",appId:"1:597414564277:web:1f79b81f567b67166c89fc"});
const auth=firebase.auth(),db=firebase.firestore();
let U=null,R=[],Tr=[],W=[],friends=[],plans=[],userCrags=[];

auth.onAuthStateChanged(async u=>{document.getElementById('loadPage').style.display='none';
  if(u){U=u;document.getElementById('loginPage').style.display='none';document.getElementById('appWrap').style.display='block';
    document.getElementById('uPic').src=u.photoURL||'';document.getElementById('uName').textContent=u.displayName||u.email;
    await db.collection('users').doc(u.uid).set({name:u.displayName,email:u.email,photo:u.photoURL},{merge:true});
    await loadData();rH();}
  else{U=null;document.getElementById('loginPage').style.display='';document.getElementById('appWrap').style.display='none';}});
function loginGoogle(){auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());}
function logout(){auth.signOut();}

async function loadData(){if(!U)return;const uid=U.uid;
  let q=await db.collection('users').doc(uid).collection('routes').orderBy('date','desc').get();R=[];q.forEach(d=>{R.push({id:d.id,...d.data()});});
  q=await db.collection('users').doc(uid).collection('trains').orderBy('date','desc').get();Tr=[];q.forEach(d=>{Tr.push({id:d.id,...d.data()});});
  q=await db.collection('users').doc(uid).collection('workouts').get();W=[];q.forEach(d=>{W.push({id:d.id,...d.data()});});
  q=await db.collection('users').doc(uid).collection('friends').get();friends=[];q.forEach(d=>{friends.push({id:d.id,...d.data()});});
  q=await db.collection('users').doc(uid).collection('plans').get();plans=[];q.forEach(d=>{plans.push({id:d.id,...d.data()});});
  q=await db.collection('crags').get();userCrags=[];q.forEach(d=>{userCrags.push({id:d.id,...d.data()});});
  updDL();}
function updDL(){const s=new Set();R.forEach(r=>{if(r.sitio)s.add(r.sitio);});let dl='';[...CRAGS.keys(),...userCrags.map(c=>c.name),...s].forEach(n=>{dl+=`<option value="${n}">`;});document.getElementById('dlZ').innerHTML=dl;}

async function saveRoute(data){if(!U)return;const col=db.collection('users').doc(U.uid).collection('routes');
  if(data.id&&data.id.length>5){await col.doc(data.id).set(data);const i=R.findIndex(r=>r.id===data.id);if(i>=0)R[i]=data;}
  else{const ref=await col.add(data);data.id=ref.id;R.unshift(data);}}
async function deleteRoute(id){if(!U)return;await db.collection('users').doc(U.uid).collection('routes').doc(id).delete();R=R.filter(r=>r.id!==id);}
async function saveTrain(data){if(!U)return;const ref=await db.collection('users').doc(U.uid).collection('trains').add(data);data.id=ref.id;Tr.unshift(data);}
async function saveWorkout(data){if(!U)return;const ref=await db.collection('users').doc(U.uid).collection('workouts').add(data);data.id=ref.id;W.push(data);}
async function delWorkout(id){if(!U)return;await db.collection('users').doc(U.uid).collection('workouts').doc(id).delete();W=W.filter(w=>w.id!==id);}
async function savePlan(data){if(!U)return;const ref=await db.collection('users').doc(U.uid).collection('plans').add(data);data.id=ref.id;plans.push(data);}
async function saveCrag(data){if(!U)return;const ref=await db.collection('crags').add(data);data.id=ref.id;userCrags.push(data);updDL();}

// CRAGS DB
const CRAGS=new Map([["Atauri",[42.77,-2.52]],["Etxauri",[42.83,-1.87]],["Riglos",[42.35,-0.72]],["Siurana",[41.25,0.93]],["Margalef",[41.28,0.75]],["Rodellar",[42.27,-0.08]],["Oliana",[42.07,1.31]],["Chulilla",[39.66,-0.89]],["Montanejos",[40.07,-0.53]],["Sella",[38.63,-0.27]],["Santa Linya",[41.98,0.76]],["Terradets",[42.07,0.84]],["El Chorro",[36.92,-4.77]],["Archidona",[37.09,-4.39]],["San Bartolo",[36.08,-5.63]],["O√±ati",[42.98,-2.41]],["Araotz",[42.97,-2.41]],["Leitza",[43.09,-1.90]],["Tres Ponts",[42.12,1.15]],["Kalymnos",[36.96,26.98]],["Leonidio",[37.16,22.86]],["Fontainebleau",[48.40,2.63]],["Ce√ºse",[44.50,5.95]],["Verdon",[43.75,6.40]],["Buoux",[43.82,5.38]],["Finale Ligure",[44.17,8.34]],["Arco",[45.92,10.88]],["Loja",[37.17,-4.15]],["Teverga",[43.15,-6.08]],["Pe√±√≥n de Ifach",[38.63,0.08]],["Albarrac√≠n",[40.41,-1.44]],["Cuenca",[40.06,-2.13]],["La Pedriza",[40.75,-3.87]],["Patones",[40.87,-3.57]],["Geyikbayiri",[37.15,30.48]],["Railay",[8.01,98.84]],["El Potrero Chico",[25.95,-100.47]],["Berdejo",[41.63,-1.93]],["Calcena",[41.63,-1.70]],["Morata de Jal√≥n",[41.48,-1.47]],["Baltzola",[43.14,-2.63]],["Aizkorri",[42.95,-2.35]]]);
function getCragCoords(name){if(!name)return null;const nl=name.toLowerCase();
  for(const[k,v]of CRAGS){if(nl.includes(k.toLowerCase()))return{name:k,lat:v[0],lng:v[1]};}
  for(const c of userCrags){if(nl.includes(c.name.toLowerCase()))return{name:c.name,lat:c.lat,lng:c.lng};}
  return null;}

const G=["V","6a","6a+","6b","6b+","6c","6c+","7a","7a+","7b","7b+","7c","7c+","8a","8a+","8b","8b+","8c","8c+","9a","9a+","9b","9b+","9c"];
const CT=["1234321","1-3-5","112233","1-max"],AN=["90gr","120gr","Lock-off"],AG=["Regleta","Cazo","Pinza","Romo"];
let cY=2026,cMo=1,cSl=null,gM='cr',gPer='year',sPer='year',rFl='all',tTb='hist',eRt=null,cE=null,wSt=[],leafMap=null,markers=[];
const PG={home:'ph',routes:'pv',map:'pm',train:'pt',friends:'pf',sync:'ps'},PK=Object.keys(PG);
function go(id){Object.values(PG).forEach(p=>document.getElementById(p).classList.remove('on'));document.querySelectorAll('.nb').forEach(b=>b.classList.remove('on'));document.getElementById(PG[id]).classList.add('on');document.querySelectorAll('.nb')[PK.indexOf(id)].classList.add('on');({home:rH,routes:drR,map:drM,train:drTr,friends:drFr,sync:drS})[id]();}

// HOME
function rH(){updStats();rCal();updGrToggles();}
function updStats(){const y=new Date().getFullYear(),yr=R.filter(r=>new Date(r.date).getFullYear()===y);
  let sp='';[['year','A√±o'],['life','Siempre']].forEach(([k,lb])=>{sp+=`<button class="gp${sPer===k?' on':''}" onclick="sPer='${k}';updStats()">${lb}</button>`;});
  document.getElementById('sPer').innerHTML=sp;
  const sr=sPer==='year'?yr:R;const st=sPer==='year'?Tr.filter(t=>new Date(t.date).getFullYear()===y):Tr;
  document.getElementById('sV').textContent=sr.length;document.getElementById('sE').textContent=sr.filter(r=>r.enc).length;
  document.getElementById('sT').textContent=st.length;
  document.getElementById('sVl').textContent=sPer==='year'?'V√≠as / a√±o':'V√≠as total';
  document.getElementById('sEl').textContent=sPer==='year'?'Enc / a√±o':'Enc total';
  document.getElementById('sTl').textContent=sPer==='year'?'Entrenos / a√±o':'Entrenos total';}
function updGrToggles(){
  let gp='';[['year','A√±o'],['life','Siempre']].forEach(([k,lb])=>{gp+=`<button class="gp${gPer===k?' on':''}" onclick="gPer='${k}';rGr();updGrToggles()">${lb}</button>`;});
  document.getElementById('gPer').innerHTML=gp;
  let gs='';[['all','Todas'],['cr','Cuerda Roca'],['br','Bloq Roco'],['cro','Cuerda Roco'],['ar','Auto Roco']].forEach(([k,lb])=>{gs+=`<button class="gs${gM===k?' on':''}" onclick="gM='${k}';rGr();updGrToggles()">${lb}</button>`;});
  document.getElementById('gS').innerHTML=gs;rGr();}
function rCal(){const mN=["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];
  document.getElementById('cM').textContent=mN[cMo]+' '+cY;const f=new Date(cY,cMo,1);let sd=f.getDay();if(sd===0)sd=7;sd--;const dm=new Date(cY,cMo+1,0).getDate(),td=new Date();
  let h='';['L','M','X','J','V','S','D'].forEach(d=>{h+=`<div class="cdh">${d}</div>`;});
  for(let i=0;i<sd;i++)h+='<div class="cd emp"></div>';
  for(let d=1;d<=dm;d++){const ds=`${cY}-${String(cMo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dr=R.filter(r=>r.date===ds),hr=dr.some(r=>r.lugar==='roca'),hc=dr.some(r=>r.lugar==='roco'),ht=Tr.some(t=>t.date===ds);
    const hp=plans.some(p=>p.date===ds),hwk=W.some(w=>w.plannedDate===ds);
    const it=d===td.getDate()&&cMo===td.getMonth()&&cY===td.getFullYear();
    let c='cd';if(it)c+=' tod';if(hr&&hc)c+=' hb';else if(hr)c+=' hr';else if(hc)c+=' hc';
    if(ht)c+=' ht';if(hp&&!hr&&!hc)c+=' plan';if(hwk&&!hr&&!hc&&!hp)c+=' hw';if(cSl===ds)c+=' sel';
    h+=`<div class="${c}" onclick="cSl=cSl==='${ds}'?null:'${ds}';rCal()">${d}</div>`;}
  document.getElementById('cG').innerHTML=h;
  let det='';
  if(cSl){const dr=R.filter(r=>r.date===cSl),dt=Tr.filter(t=>t.date===cSl),dp=plans.filter(p=>p.date===cSl),dw=W.filter(w=>w.plannedDate===cSl),dd=new Date(cSl);
    det=`<div style="font-size:12px;color:var(--text2);margin-bottom:6px">${dd.toLocaleDateString('es-ES',{weekday:'long',day:'numeric',month:'long'})}</div>`;
    dp.forEach(p=>{det+=`<div style="font-size:11px;color:var(--blue);margin:2px 0">üìã Plan: ${p.lugar||''} (${p.tipo}) ${p.notas||''}</div>`;});
    dw.forEach(w=>{det+=`<div style="font-size:11px;color:var(--purple);margin:2px 0">üèã Entreno: ${w.name}</div>`;});
    dr.forEach(r=>{det+=`<div style="font-size:12px;margin:2px 0"><span style="color:${r.enc?'var(--green)':'var(--rock)'};font-family:'Bebas Neue';font-size:16px">${r.grado}</span> ${r.tipo} ${r.enc?'‚úì':''}${r.nombre?' ¬∑ '+r.nombre:''}</div>`;});
    dt.forEach(t=>{det+=`<div style="font-size:12px;margin:2px 0;color:var(--yellow)">üèã ${t.tipo} ${t.detail}</div>`;});
    if(!dr.length&&!dt.length&&!dp.length&&!dw.length)det+='<div style="font-size:12px;color:var(--text3)">Sin actividad</div>';
    det+=`<button style="margin-top:6px;background:var(--bg3);border:1px solid var(--blue);border-radius:8px;color:var(--blue);padding:5px 12px;font-size:11px;cursor:pointer;font-family:Nunito" onclick="openPlan('${cSl}')">+ Planificar</button>`;}
  document.getElementById('cD').innerHTML=det;}
function cNav(d){cMo+=d;if(cMo>11){cMo=0;cY++;}if(cMo<0){cMo=11;cY--;}rCal();}
function rGr(){const y=new Date().getFullYear();
  const base=gPer==='year'?R.filter(r=>new Date(r.date).getFullYear()===y):R;
  let f;
  if(gM==='all')f=base;
  else if(gM==='cr')f=base.filter(r=>r.lugar==='roca'&&r.tipo==='Cuerda');
  else if(gM==='br')f=base.filter(r=>r.lugar==='roco'&&r.tipo==='Bloque');
  else if(gM==='cro')f=base.filter(r=>r.lugar==='roco'&&r.tipo==='Cuerda');
  else f=base.filter(r=>r.lugar==='roco'&&r.tipo==='AutoAseg');
  const c={};f.forEach(r=>{c[r.grado]=(c[r.grado]||0)+1;});const s=Object.entries(c).sort((a,b)=>G.indexOf(b[0])-G.indexOf(a[0]));
  const mx=Math.max(...s.map(x=>x[1]),1);
  const cc=(gM==='br'||gM==='cro'||gM==='ar')?'ro':(gM==='all'?'rc':'rc');
  let h=`<div style="font-size:11px;color:var(--text2);margin-bottom:6px">${f.length} v√≠as${gPer==='year'?' este a√±o':' en total'}</div>`;
  s.slice(0,10).forEach(([g,n])=>{h+=`<div class="gr"><div class="grn">${g}</div><div class="grb"><div class="grf ${cc}" style="width:${(n/mx)*100}%">${n}</div></div></div>`;});
  document.getElementById('gB').innerHTML=h||'<div style="color:var(--text3);font-size:12px;padding:10px">Sin datos</div>';}
function openPlan(dt){document.getElementById('plDt').value=dt;document.getElementById('plLg').value='';document.getElementById('plNo').value='';document.getElementById('mPl').classList.add('sh');}
async function svPlan(){await savePlan({date:document.getElementById('plDt').value,lugar:document.getElementById('plLg').value,tipo:document.getElementById('plTp').value,notas:document.getElementById('plNo').value});cm('mPl');rCal();}

// ROUTES
function drR(){let fc='';[['all','Todas'],['roca','Roca'],['roco','Roc√≥dromo'],['enc','Encadenadas'],['cuerda','Cuerda'],['bloque','Bloque']].forEach(([k,lb])=>{fc+=`<button class="ch${rFl===k?' on':''}" onclick="rFl='${k}';drR()">${lb}</button>`;});document.getElementById('rF').innerHTML=fc;
  let fl=R.slice();if(rFl==='roca')fl=fl.filter(r=>r.lugar==='roca');if(rFl==='roco')fl=fl.filter(r=>r.lugar==='roco');if(rFl==='enc')fl=fl.filter(r=>r.enc);if(rFl==='cuerda')fl=fl.filter(r=>r.tipo==='Cuerda');if(rFl==='bloque')fl=fl.filter(r=>r.tipo==='Bloque');
  const so=document.getElementById('rS').value;if(so==='date')fl.sort((a,b)=>b.date.localeCompare(a.date));if(so==='dateA')fl.sort((a,b)=>a.date.localeCompare(b.date));if(so==='grD')fl.sort((a,b)=>G.indexOf(b.grado)-G.indexOf(a.grado));if(so==='grA')fl.sort((a,b)=>G.indexOf(a.grado)-G.indexOf(b.grado));if(so==='lugar')fl.sort((a,b)=>(a.sitio||'').localeCompare(b.sitio||''));if(so==='amigo')fl.sort((a,b)=>(a.amigos||'').localeCompare(b.amigos||''));
  let h='',ld2='';const byD=so==='date'||so==='dateA';
  fl.forEach(r=>{if(byD&&r.date!==ld2){h+=`<div style="font-family:'Bebas Neue';font-size:12px;color:var(--text3);margin:12px 0 5px;letter-spacing:2px">${new Date(r.date).toLocaleDateString('es-ES',{weekday:'short',day:'numeric',month:'short'}).toUpperCase()}</div>`;ld2=r.date;}h+=vc(r,true);});
  document.getElementById('rL').innerHTML=h||'<div style="text-align:center;color:var(--text3);padding:30px">Sin v√≠as</div>';}
function vc(r,ed){return `<div class="via ${r.enc?'enc':''}" ${ed?`onclick="edR('${r.id}')"`:''}><div class="vt"><div class="vg">${r.grado}</div><div class="vd">${new Date(r.date).toLocaleDateString('es-ES',{day:'numeric',month:'short'})}</div></div>${r.nombre?`<div class="vn">${r.nombre}</div>`:''}${r.sitio?`<div class="vl">üìç ${r.sitio}</div>`:''}<div class="vts"><span class="tg r">${r.lugar==='roca'?'Roca':'Roco'}</span><span class="tg t">${r.tipo}</span><span class="tg">Int:${r.intento||1}</span>${r.enc?'<span class="tg e">Enc ‚úì</span>':''}${r.amigos?`<span class="tg">üë• ${r.amigos}</span>`:''}${r.notas?'<span class="tg">üí¨</span>':''}</div></div>`;}
function pSel(){const g=document.getElementById('iG');g.innerHTML='';G.forEach(x=>{g.innerHTML+=`<option>${x}</option>`;});const i=document.getElementById('iI');i.innerHTML='';for(let j=1;j<=9;j++)i.innerHTML+=`<option>${j}</option>`;}
function addR(){eRt=null;document.getElementById('mRT').textContent='NUEVA V√çA';pSel();['iN','iL','iNo','iA'].forEach(id=>document.getElementById(id).value='');document.getElementById('iFe').value=new Date().toISOString().split('T')[0];document.getElementById('iG').value='7a';document.getElementById('iE').value='0';document.getElementById('btnDelR').style.display='none';document.getElementById('mR1').classList.add('sh');}
function edR(id){const r=R.find(x=>x.id===id);if(!r)return;eRt=id;document.getElementById('mRT').textContent='EDITAR V√çA';pSel();document.getElementById('iN').value=r.nombre||'';document.getElementById('iL').value=r.sitio||'';document.getElementById('iLT').value=r.lugar;document.getElementById('iTP').value=r.tipo;document.getElementById('iG').value=r.grado;document.getElementById('iI').value=r.intento||1;document.getElementById('iE').value=r.enc?'1':'0';document.getElementById('iNo').value=r.notas||'';document.getElementById('iA').value=r.amigos||'';document.getElementById('iFe').value=r.date;document.getElementById('btnDelR').style.display='block';document.getElementById('mR1').classList.add('sh');}
async function svR(){const d={date:document.getElementById('iFe').value,lugar:document.getElementById('iLT').value,tipo:document.getElementById('iTP').value,grado:document.getElementById('iG').value,intento:parseInt(document.getElementById('iI').value),enc:document.getElementById('iE').value==='1',nombre:document.getElementById('iN').value,sitio:document.getElementById('iL').value,notas:document.getElementById('iNo').value,amigos:document.getElementById('iA').value};if(eRt)d.id=eRt;await saveRoute(d);cm('mR1');drR();}
async function delR(){if(!eRt||!confirm('¬øEliminar esta v√≠a?'))return;await deleteRoute(eRt);cm('mR1');drR();}
function cm(id){document.getElementById(id).classList.remove('sh');if(id==='mNC')document.getElementById('mapDiv').style.display='block';}

// MAP
function drM(){const rr=R.filter(r=>r.lugar==='roca');document.getElementById('mTotal').textContent=rr.length;document.getElementById('mEnc').textContent=rr.filter(r=>r.enc).length;
  const locs=buildLocs(rr);document.getElementById('mZonas').textContent=Object.keys(locs).length;
  if(!leafMap){leafMap=L.map('mapDiv',{zoomControl:false}).setView([40.4,-2.5],5);L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'¬©OSM',maxZoom:18}).addTo(leafMap);L.control.zoom({position:'topright'}).addTo(leafMap);}
  renderMarkers(locs);setTimeout(()=>leafMap.invalidateSize(),100);
  document.getElementById('mRt').innerHTML='<div style="color:var(--text3);font-size:11px;text-align:center;padding:8px">Pulsa un punto o busca arriba</div>';document.getElementById('mapResults').style.display='none';document.getElementById('mapQ').value='';}
function buildLocs(rr){const locs={};rr.forEach(r=>{if(!r.sitio)return;const c=getCragCoords(r.sitio);if(c){if(!locs[c.name])locs[c.name]={...c,rs:[],enc:0};locs[c.name].rs.push(r);if(r.enc)locs[c.name].enc++;}});return locs;}
function renderMarkers(locs){markers.forEach(m=>leafMap.removeLayer(m));markers=[];const bounds=[];
  Object.values(locs).forEach(l=>{const sz=Math.min(8+l.rs.length*3,28);
    const icon=L.divIcon({className:'',html:`<div style="width:${sz}px;height:${sz}px;background:var(--rock);border-radius:50%;border:2px solid #fff;opacity:.9;display:flex;align-items:center;justify-content:center;font-size:${Math.max(9,sz/2.5)}px;font-weight:700;color:#000;font-family:Nunito">${l.rs.length}</div>`,iconSize:[sz,sz],iconAnchor:[sz/2,sz/2]});
    const m=L.marker([l.lat,l.lng],{icon}).addTo(leafMap);m.bindPopup(`<b style="font-family:'Bebas Neue';font-size:16px;color:var(--rock)">${l.name}</b><br>${l.rs.length} v√≠as ¬∑ ${l.enc} enc.`);
    m.on('click',()=>showZone(l));markers.push(m);bounds.push([l.lat,l.lng]);});
  if(bounds.length>1)leafMap.fitBounds(bounds,{padding:[30,30]});else if(bounds.length===1)leafMap.setView(bounds[0],10);}
function showZone(l){let h=`<div style="font-family:'Bebas Neue';font-size:16px;color:var(--rock);margin:8px 0">${l.name} ‚Äî ${l.rs.length} v√≠as (${l.enc} enc.)</div>`;l.rs.forEach(r=>{h+=vc(r,true);});document.getElementById('mRt').innerHTML=h;}
function filterMap(){const q=document.getElementById('mapQ').value.trim().toLowerCase();if(!q){document.getElementById('mapResults').style.display='none';return;}
  const rr=R.filter(r=>r.lugar==='roca');const locs=buildLocs(rr);const match=Object.values(locs).filter(l=>l.name.toLowerCase().includes(q));
  if(match.length===1){leafMap.setView([match[0].lat,match[0].lng],10);showZone(match[0]);document.getElementById('mapResults').style.display='none';}
  else if(match.length>1){let h='';match.forEach(l=>{h+=`<div class="fr-card" style="cursor:pointer" onclick="leafMap.setView([${l.lat},${l.lng}],10);showZone(mapLocs['${l.name}'])"><div class="fr-info"><div class="fr-name" style="color:var(--rock)">${l.name}</div><div class="fr-email">${l.rs.length} v√≠as</div></div></div>`;});
    document.getElementById('mapResults').innerHTML=h;document.getElementById('mapResults').style.display='block';window.mapLocs={};match.forEach(l=>{window.mapLocs[l.name]=l;});}
  else{document.getElementById('mapResults').innerHTML='<div style="color:var(--text3);font-size:11px;padding:8px">No encontrado</div>';document.getElementById('mapResults').style.display='block';}}
function openNewCrag(){document.getElementById('ncNm').value='';document.getElementById('ncCoords').value='';document.getElementById('ncMsg').textContent='';document.getElementById('mapDiv').style.display='none';document.getElementById('mNC').classList.add('sh');}
async function svNewCrag(){const nm=document.getElementById('ncNm').value.trim(),raw=document.getElementById('ncCoords').value.trim(),msg=document.getElementById('ncMsg');
  if(!nm){msg.textContent='Pon un nombre';msg.style.color='var(--red)';return;}
  if(!raw){msg.textContent='Pega las coordenadas';msg.style.color='var(--red)';return;}
  let lat,lng;
  // Try to extract from Google Maps URL (@lat,lng)
  const urlMatch=raw.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
  if(urlMatch){lat=parseFloat(urlMatch[1]);lng=parseFloat(urlMatch[2]);}
  else{// Try direct coords: "43.27, -3.10" or "43.27 -3.10"
    const parts=raw.split(/[,\s]+/).filter(x=>x.length>0&&!isNaN(parseFloat(x)));
    if(parts.length>=2){lat=parseFloat(parts[0]);lng=parseFloat(parts[1]);}}
  if(isNaN(lat)||isNaN(lng)||lat<-90||lat>90||lng<-180||lng>180){
    msg.textContent='No he podido leer las coordenadas. Pega algo como: 43.270854, -3.102539';msg.style.color='var(--red)';return;}
  msg.textContent='Guardando...';msg.style.color='var(--green)';
  try{await saveCrag({name:nm,lat,lng});cm('mNC');document.getElementById('mapDiv').style.display='block';drM();}
  catch(e){msg.textContent='Error al guardar: '+e.message;msg.style.color='var(--red)';}}

// TRAINS
function drTr(){let tb='';[['hist','Historial'],['plan','Programados']].forEach(([k,lb])=>{tb+=`<button class="tb${tTb===k?' on':''}" onclick="tTb='${k}';drTr()">${lb}</button>`;});document.getElementById('tT').innerHTML=tb;
  if(tTb==='hist'){document.getElementById('tH').style.display='block';document.getElementById('tP').style.display='none';let h='';Tr.forEach(t=>{h+=`<div class="trn"><div style="display:flex;justify-content:space-between"><div class="tt2">${t.tipo}</div><div style="font-size:10px;color:var(--text3)">${new Date(t.date).toLocaleDateString('es-ES',{day:'numeric',month:'short'})}</div></div><div class="td">${t.detail}</div></div>`;});document.getElementById('tH').innerHTML=h||'<div style="color:var(--text3);text-align:center;padding:20px">Sin entrenos</div>';}
  else{document.getElementById('tH').style.display='none';document.getElementById('tP').style.display='block';let h='';W.forEach(w=>{h+=`<div class="wi"><button class="wi-del" onclick="delWo('${w.id}')">‚úï</button><div class="wit">${w.name}</div>${w.plannedDate?`<div class="wi-date">üìÖ ${new Date(w.plannedDate).toLocaleDateString('es-ES',{weekday:'short',day:'numeric',month:'short'})}</div>`:''}<div class="wis">`;(w.steps||[]).forEach((s,i)=>{h+=`<div class="wiss">${i+1}. ${s.txt||s}</div>`;});h+=`</div><button class="wib" onclick="alert('üì° BT pr√≥ximamente')">üì° ESP32</button></div>`;});document.getElementById('wL').innerHTML=h;}}
async function delWo(id){if(confirm('¬øEliminar?')){await delWorkout(id);drTr();}}
function openWo(){wSt=[];cE=null;document.getElementById('wNm').value='';document.getElementById('wDt').value='';document.getElementById('eP').style.display='none';document.getElementById('eA').style.display='none';
  let eg='';[['regletas','ü§è','Regletas'],['campus','üßó','Campus'],['rebotes','üí•','Rebotes'],['bloqueos','üí™','Bloqueos'],['travesia','üîÑ','Traves√≠a'],['temporizador','‚è±Ô∏è','Timer'],['libre','üìù','Libre']].forEach(([k,ic,lb])=>{eg+=`<div class="eb" data-e="${k}" onclick="sE('${k}')"><div class="ic">${ic}</div>${lb}</div>`;});
  document.getElementById('eG').innerHTML=eg;rWS();document.getElementById('mW1').classList.add('sh');}
function rWS(){let h='';if(!wSt.length)h='<div style="color:var(--text3);font-size:11px;padding:6px">A√±ade ejercicios</div>';wSt.forEach((s,i)=>{h+=`<div class="ws"><div class="wn">${i+1}</div><div class="wd">${s.txt}</div><button class="wr" onclick="wSt.splice(${i},1);rWS()">‚úï</button></div>`;});document.getElementById('wS').innerHTML=h;}
function fld(id,lb,v){return `<div class="fl"><label>${lb}</label><input id="${id}" type="number" value="${v}"></div>`;}
function sE(t){cE=t;document.querySelectorAll('.eb').forEach(b=>b.classList.remove('on'));document.querySelector(`.eb[data-e="${t}"]`).classList.add('on');document.getElementById('eA').style.display='block';const p=document.getElementById('eP');p.style.display='block';let h='<div class="ep">';
  if(t==='regletas')h+=fld('xC','Colgado s',7)+fld('xD','Descanso s',3)+fld('xR','Reps',6)+fld('xS','Series',4)+fld('xDS','Desc.serie',180)+fld('xP','Peso kg',0)+fld('xRg','Regleta mm',20);
  else if(t==='campus'){h+=`<div class="fl"><label>Tipo</label><select id="xCT">${CT.map((c,i)=>`<option value="${i}">${c}</option>`).join('')}</select></div>`;h+=fld('xD','Descanso',60)+fld('xS','Series',4)+fld('xDS','Desc.serie',180)+fld('xRg','Regleta mm',20);}
  else if(t==='rebotes')h+=fld('xT','Tiempo s',5)+fld('xD','Descanso',5)+fld('xR','Reps',8)+fld('xS','Series',3)+fld('xDS','Desc.serie',120)+fld('xRg','Regleta mm',14);
  else if(t==='bloqueos'){h+=`<div class="fl"><label>√Ångulo</label><select id="xAn">${AN.map((a,i)=>`<option value="${i}">${a}</option>`).join('')}</select></div><div class="fl"><label>Agarre</label><select id="xAg">${AG.map((a,i)=>`<option value="${i}">${a}</option>`).join('')}</select></div>`;h+=fld('xT','Tiempo s',10)+fld('xD','Descanso',30)+fld('xR','Reps',3)+fld('xS','Series',3)+fld('xDS','Desc.serie',180)+fld('xP','Peso kg',0)+fld('xRg','Regleta mm',20);}
  else if(t==='travesia'){h+=`<div class="fl"><label>Modo</label><select id="xTM"><option value="0">Movimientos</option><option value="1">Tiempo</option></select></div>`;h+=fld('xMv','Movimientos',30)+fld('xTi','Tiempo s',180)+fld('xD','Descanso',180)+fld('xS','Series',3);}
  else if(t==='temporizador')h+=fld('xMi','Minutos',3)+fld('xSe','Segundos',0);
  else if(t==='libre')h+=`<div class="fl" style="grid-column:1/-1"><label>Descripci√≥n</label><input id="xLb" placeholder="10x gomas hombros"></div>`;
  h+='</div>';p.innerHTML=h;}
function gv(id){const e=document.getElementById(id);return e?parseInt(e.value)||0:0;}
function addEj(){if(!cE)return;let s={tipo:cE,p:{},txt:''};
  if(cE==='regletas'){const p={col:gv('xC'),des:gv('xD'),rep:gv('xR'),ser:gv('xS'),ds:gv('xDS'),peso:gv('xP'),reg:gv('xRg')};s.p=p;s.txt=`Regletas ${p.ser}x${p.rep} ${p.col}s/${p.des}s ${p.reg}mm${p.peso>0?' +'+p.peso+'kg':''}`;}
  else if(cE==='campus'){const ti=gv('xCT'),p={t:ti,des:gv('xD'),ser:gv('xS'),ds:gv('xDS'),reg:gv('xRg')};s.p=p;s.txt=`Campus ${p.ser}ser ${CT[ti]} ${p.reg}mm`;}
  else if(cE==='rebotes'){const p={tie:gv('xT'),des:gv('xD'),rep:gv('xR'),ser:gv('xS'),ds:gv('xDS'),reg:gv('xRg')};s.p=p;s.txt=`Rebotes ${p.ser}x${p.rep} ${p.tie}s ${p.reg}mm`;}
  else if(cE==='bloqueos'){const ai=gv('xAn'),ag=gv('xAg'),p={ang:ai,agarre:ag,tie:gv('xT'),des:gv('xD'),rep:gv('xR'),ser:gv('xS'),ds:gv('xDS'),peso:gv('xP'),reg:gv('xRg')};s.p=p;s.txt=`Bloqueos ${p.ser}x${p.rep} ${p.tie}s ${AN[ai]} ${AG[ag]}${p.peso>0?' +'+p.peso+'kg':''}`;}
  else if(cE==='travesia'){const m=gv('xTM'),p={modo:m,mov:gv('xMv'),ti:gv('xTi'),des:gv('xD'),ser:gv('xS')};s.p=p;s.txt=m===0?`Traves√≠a ${p.ser}x ${p.mov}mov`:`Traves√≠a ${p.ser}x ${p.ti}s`;}
  else if(cE==='temporizador'){const p={min:gv('xMi'),seg:gv('xSe')};s.p=p;s.txt=`Timer ${p.min}:${String(p.seg).padStart(2,'0')}`;}
  else if(cE==='libre'){const t=(document.getElementById('xLb').value||'').trim();if(!t)return;s.p={text:t};s.txt=t;}
  wSt.push(s);rWS();cE=null;document.querySelectorAll('.eb').forEach(b=>b.classList.remove('on'));document.getElementById('eP').style.display='none';document.getElementById('eA').style.display='none';}
async function svW(){const n=(document.getElementById('wNm').value||'').trim();if(!n||!wSt.length){alert('Pon nombre y ejercicios');return;}
  const d={name:n,steps:[...wSt]};const dt=document.getElementById('wDt').value;if(dt)d.plannedDate=dt;await saveWorkout(d);cm('mW1');tTb='plan';drTr();}

// FRIENDS
async function drFr(){let h='';if(!friends.length)h='<div style="color:var(--text3);font-size:11px;text-align:center;padding:16px">A√±ade amigos por email</div>';
  for(const f of friends){const q=await db.collection('users').where('email','==',f.email).get();let name=f.email,photo='';
    if(!q.empty){const ud=q.docs[0].data();name=ud.name||f.email;photo=ud.photo||'';}
    h+=`<div class="fr-card" onclick="viewFr('${f.email}')"><img class="fr-pic" src="${photo||'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><circle cx=%2212%22 cy=%228%22 r=%224%22 fill=%22%238a9bb0%22/><path d=%22M4 20c0-4 4-7 8-7s8 3 8 7%22 fill=%22%238a9bb0%22/></svg>'}"><div class="fr-info"><div class="fr-name">${name}</div><div class="fr-email">${f.email}</div></div><button class="fr-rm" onclick="event.stopPropagation();rmFr('${f.id}')">‚úï</button></div>`;}
  document.getElementById('frList').innerHTML=h;document.getElementById('frView').style.display='none';}
async function addFriend(){const email=document.getElementById('frEmail').value.trim().toLowerCase(),msg=document.getElementById('frMsg');
  if(!email||!email.includes('@')){msg.textContent='Email no v√°lido';msg.style.color='var(--red)';return;}
  if(U&&email===U.email.toLowerCase()){msg.textContent='Ese eres t√∫';msg.style.color='var(--red)';return;}
  if(friends.some(f=>f.email===email)){msg.textContent='Ya es tu amigo';msg.style.color='var(--yellow)';return;}
  const q=await db.collection('users').where('email','==',email).get();
  if(q.empty){msg.textContent='No est√° en Sube Pies (tiene que entrar primero)';msg.style.color='var(--yellow)';return;}
  await db.collection('users').doc(U.uid).collection('friends').add({email});friends.push({email});
  document.getElementById('frEmail').value='';msg.textContent='A√±adido ‚úì';msg.style.color='var(--green)';drFr();}
async function rmFr(id){await db.collection('users').doc(U.uid).collection('friends').doc(id).delete();friends=friends.filter(f=>f.id!==id);drFr();}
async function viewFr(email){const q=await db.collection('users').where('email','==',email).get();if(q.empty)return;
  const fuid=q.docs[0].id,fd=q.docs[0].data();document.getElementById('frViewTitle').textContent='V√çAS DE '+(fd.name||email).toUpperCase();
  const rs=await db.collection('users').doc(fuid).collection('routes').orderBy('date','desc').limit(30).get();let h='';
  rs.forEach(d=>{h+=vc({id:d.id,...d.data()},false);});
  document.getElementById('frRoutes').innerHTML=h||'<div style="color:var(--text3);font-size:11px;padding:8px">Sin v√≠as</div>';document.getElementById('frView').style.display='block';}

// SYNC
let exPer='all';
function drS(){document.getElementById('sN').textContent=R.length+Tr.length;
  const td=new Date().toISOString().split('T')[0];
  let h='';[['1m','1 mes'],['3m','3 meses'],['1y','1 a√±o'],['2y','2 a√±os'],['all','Todo']].forEach(([k,lb])=>{h+=`<button class="ch${exPer===k?' on':''}" onclick="setExPer('${k}')">${lb}</button>`;});
  document.getElementById('exPer').innerHTML=h;
  if(!document.getElementById('exFrom').value)setExPer('all');}
function setExPer(p){exPer=p;const td=new Date(),to=td.toISOString().split('T')[0];
  document.getElementById('exTo').value=to;
  let from=new Date(td);
  if(p==='1m')from.setMonth(from.getMonth()-1);
  else if(p==='3m')from.setMonth(from.getMonth()-3);
  else if(p==='1y')from.setFullYear(from.getFullYear()-1);
  else if(p==='2y')from.setFullYear(from.getFullYear()-2);
  else from=new Date('2020-01-01');
  document.getElementById('exFrom').value=from.toISOString().split('T')[0];
  document.querySelectorAll('#exPer .ch').forEach(b=>b.classList.remove('on'));
  event&&event.target&&event.target.classList.add('on');}
function exportXL(tipo){
  const from=document.getElementById('exFrom').value,to=document.getElementById('exTo').value,msg=document.getElementById('exMsg');
  if(!from||!to){msg.textContent='Elige fechas';msg.style.color='var(--red)';return;}
  if(tipo==='vias'){
    const fl=R.filter(r=>r.date>=from&&r.date<=to).sort((a,b)=>a.date.localeCompare(b.date));
    if(!fl.length){msg.textContent='No hay v√≠as en ese rango';msg.style.color='var(--yellow)';return;}
    const rows=fl.map(r=>({Fecha:r.date,Nombre:r.nombre||'',Lugar:r.sitio||'',Tipo_lugar:r.lugar==='roca'?'Roca':'Roc√≥dromo',Tipo_via:r.tipo,Grado:r.grado,Intento:r.intento||1,Encadenado:r.enc?'S√≠':'No',Compa√±eros:r.amigos||'',Notas:r.notas||''}));
    const ws=XLSX.utils.json_to_sheet(rows);ws['!cols']=[{wch:12},{wch:20},{wch:15},{wch:12},{wch:10},{wch:8},{wch:8},{wch:10},{wch:15},{wch:25}];
    const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'V√≠as');
    XLSX.writeFile(wb,`sube_pies_vias_${from}_${to}.xlsx`);
    msg.textContent=`‚úì ${fl.length} v√≠as exportadas`;msg.style.color='var(--green)';}
  else{
    const fl=Tr.filter(t=>t.date>=from&&t.date<=to).sort((a,b)=>a.date.localeCompare(b.date));
    if(!fl.length){msg.textContent='No hay entrenos en ese rango';msg.style.color='var(--yellow)';return;}
    const rows=fl.map(t=>({Fecha:t.date,Tipo:t.tipo,Detalle:t.detail||''}));
    const ws=XLSX.utils.json_to_sheet(rows);ws['!cols']=[{wch:12},{wch:15},{wch:40}];
    const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Entrenos');
    XLSX.writeFile(wb,`sube_pies_entrenos_${from}_${to}.xlsx`);
    msg.textContent=`‚úì ${fl.length} entrenos exportados`;msg.style.color='var(--green)';}}
async function doBT(){const b=document.getElementById('bB'),t=document.getElementById('bT');
  if(!navigator.bluetooth){t.textContent='Usa Chrome en Android';return;}
  try{t.textContent='Buscando...';b.textContent='...';
    const dev=await navigator.bluetooth.requestDevice({filters:[{namePrefix:'SubePies'}],optionalServices:['0000ffe0-0000-1000-8000-00805f9b34fb']});
    const srv=await dev.gatt.connect();const svc=await srv.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
    const txC=await svc.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');const rxC=await svc.getCharacteristic('0000ffe2-0000-1000-8000-00805f9b34fb');
    b.textContent='Conectado ‚úì';b.classList.add('ok');t.textContent='Sincronizando...';
    let buf='';await txC.startNotifications();txC.addEventListener('characteristicvaluechanged',e=>{buf+=new TextDecoder().decode(e.target.value);});
    await rxC.writeValue(new TextEncoder().encode('SYNC'));await new Promise(r=>setTimeout(r,3000));
    const lines=buf.split('\n').filter(l=>l.length>0);let added=0;
    for(const line of lines){if(line.startsWith('BEGIN')||line.startsWith('END'))continue;const p=line.split('|');
      if(p[0]==='V'){const lug=['roca','roco'],tipR=['Cuerda','Bloque','AutoAseg','Largos'],tipC=['Cuerda','Bloque','AutoAseg'];
        const lugar=lug[+p[1]]||'roca',ta=lugar==='roca'?tipR:tipC;
        await saveRoute({date:new Date().toISOString().split('T')[0],lugar,tipo:ta[+p[2]]||'Cuerda',grado:G[+p[3]]||'7a',intento:+p[4]||1,enc:p[5]==='1',nombre:'',sitio:'',notas:'Sync ESP32',amigos:''});added++;}
      else if(p[0]==='T'){const tipos=['Regletas','Campus','Rebotes','Bloqueos','Travesias','Timer'];
        await saveTrain({date:new Date().toISOString().split('T')[0],tipo:tipos[+p[1]]||'Regletas',detail:p[2]||''});added++;}}
    if(added>0){await rxC.writeValue(new TextEncoder().encode('ACK'));await loadData();}
    t.textContent=`‚úì ${added} registros sincronizados`;
  }catch(e){t.textContent='Error: '+e.message;b.textContent='Conectar ESP32';b.classList.remove('ok');}}
</script>
</body>
</html>
