<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1a1d23">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1b2838">
<title>Sube Pies</title>
<link rel="manifest" href="data:application/json,{}">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<style>
:root{--bg:#141e2b;--bg2:#1b2838;--bg3:#243447;--bg4:#2d4055;--rock:#d4a574;--rockD:#8b6842;--green:#4ecdc4;--greenD:#2ea89f;--red:#ff6b6b;--yellow:#ffe66d;--blue:#4a9eff;--purple:#a78bfa;--text:#e8e0d8;--text2:#8a9bb0;--text3:#5a6a7a;--R:16px;}
*{margin:0;padding:0;box-sizing:border-box;}body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;padding-bottom:75px;position:relative;}
body::after{content:'';position:fixed;bottom:70px;left:50%;transform:translateX(-50%);width:100%;max-width:600px;height:250px;background-image:url('inicio.jpg');background-repeat:no-repeat;background-position:bottom center;background-size:cover;pointer-events:none;z-index:0;opacity:.06;mask-image:linear-gradient(to top,rgba(0,0,0,.6) 0%,transparent 100%);-webkit-mask-image:linear-gradient(to top,rgba(0,0,0,.6) 0%,transparent 100%);}
h1,h2,h3{font-family:'Bebas Neue',sans-serif;letter-spacing:1.5px;}
body::before{content:'';position:fixed;top:0;left:0;right:0;height:200px;background:linear-gradient(180deg,#1e3045,#1b2838 60%,var(--bg));z-index:-1;opacity:.7;}
.nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg2);border-top:1px solid rgba(255,255,255,.05);display:flex;z-index:100;backdrop-filter:blur(20px);padding-bottom:env(safe-area-inset-bottom);}
.nb{flex:1;padding:8px 0 6px;text-align:center;color:var(--text3);font-size:9px;cursor:pointer;border:none;background:none;font-family:'Nunito';transition:.2s;}.nb.on{color:var(--rock);}.nb svg{display:block;margin:0 auto 2px;width:20px;height:20px;}.nb.on svg{filter:drop-shadow(0 0 5px rgba(212,165,116,.4));}
.page{display:none;padding:16px;animation:fu .3s ease;position:relative;z-index:1;}.page.on{display:block;}#ph.on{display:flex!important;flex-direction:column;}@keyframes fu{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
.hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}.hdr h1{font-size:24px;color:var(--rock);}
.card{background:var(--bg2);border-radius:var(--R);padding:14px;border:1px solid rgba(255,255,255,.04);margin-bottom:12px;}.ct{font-family:'Bebas Neue';font-size:14px;color:var(--text2);letter-spacing:2px;margin-bottom:10px;}
.stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px;}.st{background:var(--bg2);border-radius:12px;padding:10px 8px;text-align:center;border:1px solid rgba(255,255,255,.04);}.st .v{font-family:'Bebas Neue';font-size:28px;line-height:1;}.st .l{font-size:9px;color:var(--text2);margin-top:2px;}.st.a .v{color:var(--rock);}.st.b .v{color:var(--green);}.st.c .v{color:var(--yellow);}
.cn{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}.cn button{background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer;padding:4px 10px;}.cn .mo{font-family:'Bebas Neue';font-size:18px;color:var(--text);}
.cg{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;}.cdh{text-align:center;font-size:9px;color:var(--text3);padding:2px 0;}
.cd{text-align:center;padding:4px 2px;border-radius:6px;font-size:11px;cursor:pointer;color:var(--text3);font-weight:400;}
.cd:hover{background:var(--bg3);}.cd.tod{outline:2px solid var(--text2);outline-offset:-2px;}
.cd.hr{color:var(--rock);font-weight:700;}.cd.hc{color:var(--green);font-weight:700;}
.cd.hb{background:linear-gradient(135deg,var(--rock),var(--green));color:#000;font-weight:700;}
.cd.ht{text-decoration:underline;text-decoration-color:var(--yellow);text-underline-offset:3px;}
.cd.plan{border:1.5px dashed var(--blue);color:var(--blue);}.cd.hw{border:1.5px dashed var(--purple);}
.cd.sel{background:var(--rock)!important;color:#000!important;font-weight:700;}.cd.emp{cursor:default;}
.gsw{display:flex;gap:0;margin-bottom:10px;background:var(--bg3);border-radius:8px;padding:2px;flex-wrap:wrap;}
.gs{flex:1;padding:5px 2px;text-align:center;border-radius:6px;font-size:10px;cursor:pointer;color:var(--text2);border:none;background:none;font-family:'Nunito';min-width:0;}.gs.on{background:var(--rock);color:#000;font-weight:700;}
.gp{flex:1;padding:5px 2px;text-align:center;border-radius:6px;font-size:10px;cursor:pointer;color:var(--text2);border:none;background:none;font-family:'Nunito';min-width:0;}.gp.on{background:var(--blue);color:#fff;font-weight:700;}
.gb{display:flex;flex-direction:column;gap:5px;}.gr{display:flex;align-items:center;gap:6px;}.grn{font-family:'Bebas Neue';font-size:14px;width:32px;text-align:right;color:var(--text2);}.grb{flex:1;height:18px;background:var(--bg3);border-radius:9px;overflow:hidden;}.grf{height:100%;border-radius:9px;display:flex;align-items:center;padding-left:6px;font-size:10px;font-weight:700;min-width:20px;}.grf.rc{background:linear-gradient(90deg,var(--rockD),var(--rock));}.grf.ro{background:linear-gradient(90deg,var(--greenD),var(--green));color:#000;}
.via{background:var(--bg2);border-radius:var(--R);padding:12px;margin-bottom:8px;border:1px solid rgba(255,255,255,.04);cursor:pointer;}.via:active{transform:scale(.98);}.via.enc .vg{color:var(--green);}.vt{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}.vg{font-family:'Bebas Neue';font-size:22px;color:var(--rock);}.vd{font-size:11px;color:var(--text3);}.vn{font-size:13px;font-weight:600;margin-bottom:3px;}.vl{font-size:11px;color:var(--text2);margin-bottom:5px;}.vts{display:flex;flex-wrap:wrap;gap:3px;}.tg{display:inline-block;padding:2px 7px;border-radius:6px;font-size:9px;background:var(--bg3);color:var(--text2);}.tg.e{background:rgba(78,205,196,.15);color:var(--green);}.tg.r{background:rgba(212,165,116,.15);color:var(--rock);}.tg.t{background:rgba(74,158,255,.15);color:var(--blue);}
.trn{background:var(--bg2);border-radius:var(--R);padding:12px;margin-bottom:8px;border-left:3px solid var(--yellow);border:1px solid rgba(255,255,255,.04);}.tt2{font-family:'Bebas Neue';font-size:18px;color:var(--yellow);}.td{font-size:12px;color:var(--text2);margin-top:4px;}
#mapDiv{height:350px;border-radius:var(--R);overflow:hidden;margin-bottom:12px;border:1px solid rgba(255,255,255,.04);}
.map-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;}
.map-search{display:flex;gap:6px;margin-bottom:12px;}.map-search input{flex:1;background:var(--bg3);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px 12px;color:var(--text);font-size:13px;font-family:'Nunito';outline:none;}.map-search input:focus{border-color:var(--rock);}
.mbg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);}.mbg.sh{display:flex;}.mdl{background:var(--bg2);border-radius:20px 20px 0 0;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;padding:20px;animation:su .3s ease;}@keyframes su{from{transform:translateY(100%)}to{transform:none}}.mdl h2{font-size:22px;color:var(--rock);margin-bottom:16px;}.mx{float:right;background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer;}
.fl{margin-bottom:12px;}.fl label{display:block;font-size:11px;color:var(--text2);margin-bottom:3px;font-weight:600;}.fl input,.fl textarea,.fl select{width:100%;background:var(--bg3);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:9px 11px;color:var(--text);font-size:13px;font-family:'Nunito';outline:none;}.fl input:focus,.fl textarea:focus,.fl select:focus{border-color:var(--rock);}.fl textarea{resize:vertical;min-height:50px;}
.fl small{font-size:10px;color:var(--text3);margin-top:2px;display:block;}
.btn{width:100%;padding:11px;border:none;border-radius:12px;font-size:14px;font-family:'Nunito';font-weight:700;cursor:pointer;}.bp{background:var(--rock);color:#000;}.bp:active{transform:scale(.97);}.bg2{background:none;border:1px solid var(--text3);color:var(--text2);margin-top:8px;}.bdel{background:var(--red);color:#fff;margin-top:8px;}
.chs{display:flex;gap:5px;margin-bottom:12px;overflow-x:auto;padding-bottom:4px;}.ch{white-space:nowrap;padding:4px 10px;border-radius:14px;font-size:10px;cursor:pointer;border:1px solid rgba(255,255,255,.08);background:var(--bg2);color:var(--text2);font-family:'Nunito';}.ch.on{background:var(--rock);color:#000;border-color:var(--rock);}
.tbs{display:flex;gap:0;margin-bottom:12px;background:var(--bg3);border-radius:10px;padding:2px;}.tb{flex:1;padding:6px;text-align:center;border-radius:8px;font-size:11px;cursor:pointer;color:var(--text2);border:none;background:none;font-family:'Nunito';}.tb.on{background:var(--rock);color:#000;font-weight:700;}
.sb{display:flex;align-items:center;gap:6px;margin-bottom:10px;}.sb label{font-size:10px;color:var(--text3);}.sb select{background:var(--bg3);border:1px solid rgba(255,255,255,.08);color:var(--text);font-size:11px;padding:4px 7px;border-radius:8px;font-family:'Nunito';outline:none;}
.eg{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;}.eb{padding:8px;text-align:center;background:var(--bg3);border:1px solid rgba(255,255,255,.08);border-radius:10px;cursor:pointer;font-size:11px;color:var(--text2);font-family:'Nunito';}.eb.on{border-color:var(--rock);color:var(--rock);background:rgba(212,165,116,.1);}.eb .ic{font-size:18px;margin-bottom:3px;}
.ep{display:grid;grid-template-columns:1fr 1fr;gap:6px;}.ep .fl{margin-bottom:6px;}.ep input,.ep select{padding:7px 9px;font-size:12px;}
.ws{background:var(--bg3);border-radius:10px;padding:8px 10px;margin-bottom:5px;display:flex;align-items:center;gap:6px;}.ws .wn{font-family:'Bebas Neue';font-size:16px;color:var(--rock);min-width:18px;}.ws .wd{flex:1;font-size:11px;}.ws .wr{background:none;border:none;color:var(--red);font-size:14px;cursor:pointer;}
.wi{background:var(--bg2);border-radius:var(--R);padding:12px;margin-bottom:8px;border:1px solid rgba(255,255,255,.04);position:relative;}.wit{font-family:'Bebas Neue';font-size:16px;color:var(--purple);}.wis{font-size:11px;color:var(--text2);margin-top:5px;}.wiss{padding:2px 0;border-bottom:1px solid rgba(255,255,255,.03);}.wib{margin-top:8px;padding:7px 12px;background:var(--bg3);border:1px solid var(--purple);border-radius:8px;color:var(--purple);font-size:11px;cursor:pointer;font-family:'Nunito';display:inline-block;margin-right:4px;}
.wi-del{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--red);font-size:16px;cursor:pointer;}
.wi-date{font-size:10px;color:var(--blue);margin-top:4px;}
.sbb{background:var(--rock);color:#000;border:none;padding:12px 28px;border-radius:25px;font-size:14px;cursor:pointer;font-family:'Nunito';font-weight:700;}.sbb:active{transform:scale(.95);}.sbb.ok{background:var(--green);}
#loginPage{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;text-align:center;}
.login-logo{font-family:'Bebas Neue';font-size:48px;color:var(--rock);margin-bottom:4px;}
.goog-btn{display:flex;align-items:center;gap:12px;background:#fff;color:#333;border:none;padding:14px 28px;border-radius:25px;font-size:15px;font-family:'Nunito';font-weight:700;cursor:pointer;}.goog-btn:active{transform:scale(.95);}.goog-btn img{width:20px;height:20px;}
.usr-bar{display:flex;align-items:center;gap:6px;padding:4px 0;}.usr-pic{width:24px;height:24px;border-radius:50%;border:2px solid var(--rock);}.usr-name{font-size:11px;color:var(--text2);}.usr-out{background:none;border:none;color:var(--text3);font-size:9px;cursor:pointer;text-decoration:underline;}.usr-tag{font-family:'Bebas Neue';font-size:11px;color:var(--rock);}
.fr-card{display:flex;align-items:center;gap:8px;background:var(--bg3);border-radius:10px;padding:8px;margin-bottom:5px;cursor:pointer;}.fr-pic{width:32px;height:32px;border-radius:50%;border:2px solid var(--rock);}.fr-info{flex:1;}.fr-name{font-size:13px;font-weight:600;}.fr-email{font-size:9px;color:var(--text3);}.fr-rm{background:none;border:none;color:var(--red);font-size:14px;cursor:pointer;}
.spinner{display:inline-block;width:20px;height:20px;border:2px solid var(--text3);border-top-color:var(--rock);border-radius:50%;animation:spin .6s linear infinite;}@keyframes spin{to{transform:rotate(360deg)}}@keyframes boltSpin{from{transform:rotateY(0deg)}to{transform:rotateY(360deg)}}
#mExec{transform-origin:center center;}
@media (orientation: portrait){#mExec .landscape-hint{display:block}#mExec #exTimer{font-size:80px;}}
@media (orientation: landscape){#mExec #exInner{flex-direction:row;flex-wrap:wrap;justify-content:center;gap:12px;padding:10px 30px}#mExec #exTimer{font-size:90px;margin:0 20px}#mExec #exTitle{font-size:26px}}
.load-full{display:flex;align-items:center;justify-content:center;min-height:100vh;}
.leaflet-popup-content-wrapper{background:var(--bg2)!important;color:var(--text)!important;border-radius:12px!important;border:1px solid var(--rock)!important;}.leaflet-popup-tip{background:var(--bg2)!important;}.leaflet-popup-content{font-family:'Nunito'!important;font-size:12px!important;}
.inv-card{background:linear-gradient(135deg,rgba(74,158,255,.15),rgba(74,158,255,.05));border:1px solid var(--blue);border-radius:12px;padding:10px;margin-bottom:6px;}.inv-who{font-size:12px;font-weight:600;color:var(--blue);}.inv-det{font-size:11px;color:var(--text2);margin:3px 0;}.inv-btns{display:flex;gap:6px;margin-top:6px;}.inv-btns button{flex:1;padding:6px;border-radius:8px;font-size:11px;font-family:'Nunito';font-weight:700;cursor:pointer;border:none;}.inv-yes{background:var(--green);color:#000;}.inv-no{background:var(--bg3);color:var(--text2);border:1px solid rgba(255,255,255,.08)!important;}
.meso-fase{background:var(--bg3);border-radius:10px;padding:8px;margin-bottom:6px;display:flex;align-items:center;gap:6px;}.meso-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0;}.meso-info{flex:1;font-size:11px;}.meso-rm{background:none;border:none;color:var(--red);font-size:13px;cursor:pointer;}
.meso-card{background:var(--bg2);border-radius:var(--R);padding:12px;margin-bottom:8px;border:1px solid rgba(255,255,255,.04);position:relative;}.meso-del{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--red);font-size:14px;cursor:pointer;}
.chat-wrap{background:var(--bg);border-radius:var(--R);border:1px solid rgba(255,255,255,.04);height:220px;overflow-y:auto;padding:8px;margin-bottom:8px;}.chat-msg{margin-bottom:5px;}.chat-msg.me{text-align:right;}.chat-bub{display:inline-block;padding:5px 10px;border-radius:12px;font-size:11px;max-width:80%;word-break:break-word;}.chat-msg.me .chat-bub{background:var(--rock);color:#000;border-bottom-right-radius:4px;}.chat-msg.ot .chat-bub{background:var(--bg3);color:var(--text);border-bottom-left-radius:4px;}.chat-time{font-size:7px;color:var(--text3);margin-top:1px;}
.chat-input{display:flex;gap:4px;}.chat-input input{flex:1;background:var(--bg3);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:8px 12px;color:var(--text);font-size:12px;font-family:'Nunito';outline:none;}.chat-input button{background:var(--rock);border:none;color:#000;width:36px;height:36px;border-radius:50%;font-size:14px;cursor:pointer;font-weight:700;}
</style>
</head>
<body>
<div id="loadPage" class="load-full"><div class="spinner" style="width:40px;height:40px;border-width:3px"></div></div>
<div id="loginPage" style="display:none;position:relative;min-height:100vh;overflow:hidden">
<img src="inicio.jpg" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:0">
<div style="position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,rgba(26,29,35,.3) 0%,rgba(26,29,35,.1) 30%,rgba(26,29,35,.7) 70%,rgba(26,29,35,.95) 100%);z-index:1"></div>
<div style="position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:20px;text-align:center">
<img src="logo.png" style="width:140px;height:140px;margin-bottom:12px;border-radius:50%;box-shadow:0 4px 30px rgba(0,0,0,.5)">
<div class="login-logo" style="text-shadow:0 2px 20px rgba(0,0,0,.6)">SUBE PIES</div>
<div style="color:rgba(255,255,255,.8);font-size:14px;margin-bottom:40px;text-shadow:0 1px 8px rgba(0,0,0,.5)">Diario de escalada</div>
<button class="goog-btn" onclick="loginGoogle()"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg">Entrar con Google</button>
<div style="color:rgba(255,255,255,.4);font-size:10px;margin-top:40px">¬© 2026 Sube Pies ¬∑ Todos los derechos reservados</div>
</div></div>
<div id="appWrap" style="display:none">
<!-- HOME --><div id="ph" class="page on" style="overflow-y:auto;height:calc(100vh - 75px);display:none">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px"><div style="display:flex;align-items:center;gap:10px"><img src="logo.png" style="width:44px;height:44px;border-radius:50%;object-fit:cover"><div><h1 style="font-size:22px;color:var(--rock);margin:0">SUBE PIES</h1><div class="usr-bar"><img class="usr-pic" id="uPic"><span class="usr-name" id="uName"></span><span class="usr-tag" id="uTag"></span><button class="usr-out" onclick="logout()">Salir</button></div></div></div></div>
<div style="width:100%;height:80px;border-radius:12px;overflow:hidden;margin-bottom:8px;position:relative"><img src="inicio.jpg" style="width:100%;height:100%;object-fit:cover;opacity:.7"><div style="position:absolute;bottom:0;left:0;right:0;height:100%;background:linear-gradient(to top,var(--bg) 0%,transparent 60%)"></div></div>
<div id="invBanner"></div>
<div class="gsw" id="sPer" style="margin-bottom:4px"></div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:6px"><div class="st a" style="padding:6px 4px"><div class="v" id="sV" style="font-size:24px">0</div><div class="l" id="sVl">V√≠as</div></div><div class="st b" style="padding:6px 4px"><div class="v" id="sE" style="font-size:24px">0</div><div class="l" id="sEl">Enc</div></div><div class="st c" style="padding:6px 4px"><div class="v" id="sT" style="font-size:24px">0</div><div class="l" id="sTl">Entrenos</div></div></div>
<div style="background:var(--bg2);border-radius:12px;padding:8px;border:1px solid rgba(255,255,255,.04);margin-bottom:0"><div class="cn" style="margin-bottom:4px"><button onclick="cNav(-1)" style="padding:2px 8px;font-size:16px">‚óÄ</button><span class="mo" id="cM" style="font-size:14px"></span><button onclick="cNav(1)" style="padding:2px 8px;font-size:16px">‚ñ∂</button></div><div class="cg" id="cG"></div></div>
<div id="calDetail" style="margin-bottom:6px"></div>
<div id="homeNextWo" style="background:var(--bg2);border-radius:12px;padding:10px;border:1px solid rgba(255,255,255,.04);margin-bottom:10px"></div>
</div>
<!-- V√çAS --><div id="pv" class="page"><div class="hdr"><h1>V√çAS</h1><button class="bp btn" style="width:auto;padding:6px 12px;font-size:11px;border-radius:10px" onclick="addR()">+ A√±adir</button></div>
<div style="background:var(--bg2);border-radius:12px;padding:8px;border:1px solid rgba(255,255,255,.04);margin-bottom:8px"><div style="display:flex;align-items:center;gap:6px;margin-bottom:4px"><span class="ct" style="margin:0;font-size:12px">GRADOS</span></div><div class="gsw" id="gPer" style="margin-bottom:4px"></div><div class="gsw" id="gS" style="margin-bottom:4px"></div><div class="gb" id="gB"></div></div>
<div style="margin-bottom:10px"><input id="vQ" placeholder="üîç Buscar v√≠a, lugar, amigo, grado..." oninput="drR()" style="width:100%;background:var(--bg3);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:8px 14px;color:var(--text);font-size:12px;font-family:Nunito;outline:none"></div><div class="chs" id="rF"></div><div class="sb"><label>Ordenar:</label><select id="rS" onchange="drR()"><option value="date">Fecha ‚Üì</option><option value="dateA">Fecha ‚Üë</option><option value="grD">Grado ‚Üì</option><option value="grA">Grado ‚Üë</option><option value="lugar">Lugar</option><option value="amigo">Compa√±ero</option></select></div><div id="rL"></div></div>
<!-- MAPA --><div id="pm" class="page"><div class="hdr"><h1>MAPA</h1></div><div style="display:flex;gap:0;margin-bottom:10px;background:var(--bg3);border-radius:10px;padding:2px" id="mapTbs"></div><div class="map-stats"><div class="st a"><div class="v" id="mTotal">0</div><div class="l">V√≠as</div></div><div class="st b"><div class="v" id="mEnc">0</div><div class="l">Enc</div></div><div class="st"><div class="v" style="color:var(--blue)" id="mZonas">0</div><div class="l">Zonas</div></div></div><div class="map-search"><input id="mapQ" placeholder="üîç Buscar zona..." oninput="filterMap()"><button class="bp btn" style="width:auto;padding:8px 12px;font-size:11px;border-radius:10px" onclick="openNewCrag()">+ Zona</button></div><div id="mapDiv"></div><div id="mapResults" style="display:none"></div><div id="mRt"></div></div>
<!-- ENTRENOS --><div id="pt" class="page"><div class="hdr"><h1>ENTRENOS</h1></div><div class="tbs" id="tT"></div><div id="tH"></div><div id="tP" style="display:none"><div id="wL"></div></div><div id="tProg" style="display:none">
<div class="ct">EXPLORADOR DE DATOS</div>
<div id="savedGraphs" style="display:flex;gap:3px;margin-bottom:6px;flex-wrap:wrap;overflow-x:auto"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px"><div class="fl" style="margin:0"><label>Desde</label><input type="date" id="grFrom"></div><div class="fl" style="margin:0"><label>Hasta</label><input type="date" id="grTo"></div></div>
<div style="display:flex;gap:3px;margin-bottom:6px;flex-wrap:wrap" id="grPresets"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px">
<div class="fl" style="margin:0"><label>Eje X</label><select id="grX" onchange="updFilters()" style="font-size:11px"><option value="mes">Mes</option><option value="semana">Semana</option><option value="dia">D√≠a</option><option value="lugar">Lugar</option><option value="compa">Compa√±ero</option><option value="grado">Grado</option><option value="tipo">Tipo v√≠a</option><option value="agarre">Agarre</option><option value="ejercicio">Ejercicio</option></select></div>
<div class="fl" style="margin:0"><label>Eje Y</label><select id="grY" style="font-size:11px"><option value="count">Cantidad v√≠as</option><option value="enc">Encadenes</option><option value="metros">Metros escalados</option><option value="lastre">Lastre m√°x (kg)</option><option value="regleta">Regleta m√≠n (mm)</option><option value="grado_max">Grado m√°ximo</option><option value="intentos">Media intentos</option><option value="dias_ent">D√≠as entrenados</option><option value="series">Total series</option><option value="reps">Total reps</option><option value="tiempo">Tiempo total (min)</option></select></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:6px">
<div class="fl" style="margin:0"><label>Fuente</label><select id="grSrc" onchange="updFilters()" style="font-size:11px"><option value="vias">V√≠as</option><option value="entrenos">Entrenos</option><option value="todo">Todo</option></select></div>
<div class="fl" style="margin:0"><label>Filtro</label><select id="grFilt" style="font-size:11px"><option value="">‚Äî</option></select></div>
<div class="fl" style="margin:0"><label>Modo</label><select id="grMode" style="font-size:11px"><option value="normal">Normal</option><option value="acum">Acumulativo</option></select></div>
</div>
<div style="display:flex;gap:4px;margin-bottom:8px"><button class="btn bp" style="flex:1;font-size:11px;padding:8px" onclick="drDash()">üìä Generar</button><button class="btn bg2" style="width:auto;padding:8px 12px;font-size:11px;margin:0" onclick="saveGraph()">üíæ</button></div>
<canvas id="cDash" height="200" style="width:100%;background:var(--bg3);border-radius:var(--R);margin-bottom:6px"></canvas>
<div id="dashInfo" style="font-size:10px;color:var(--text2)"></div>
</div><div id="tMeso" style="display:none"><button class="btn bp" onclick="openMeso()" style="margin-bottom:12px">+ Crear mesociclo</button><div id="mesoList"></div></div></div>
<!-- AMIGOS --><div id="pf" class="page"><div class="hdr"><h1>AMIGOS</h1></div><div class="card"><div class="ct">A√ëADIR AMIGO</div><div style="display:flex;gap:6px"><input id="frCode" placeholder="C√≥digo #1234 o email" style="flex:1;background:var(--bg3);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px;color:var(--text);font-size:12px;font-family:Nunito;outline:none"><button class="bp btn" style="width:auto;padding:8px 14px;font-size:12px;border-radius:10px" onclick="addFriend()">+</button></div><div id="frMsg" style="font-size:10px;margin-top:4px"></div></div><div class="ct" style="margin-top:12px">MIS AMIGOS</div><div id="frList"></div><div id="frView" style="display:none;margin-top:12px"></div></div>
<!-- CHAT MODAL --><div class="mbg" id="mChat"><div class="mdl" style="height:70vh;display:flex;flex-direction:column"><button class="mx" onclick="closeChat()">‚úï</button><h2 id="chatTitle">CHAT</h2><div class="chat-wrap" id="chatBox" style="flex:1"></div><div class="chat-input"><input id="chatIn" placeholder="Escribe..." onkeydown="if(event.key==='Enter')sendChat()"><button onclick="sendChat()">‚Üí</button></div></div></div>
<!-- AJUSTES --><div id="ps" class="page"><div class="hdr"><h1>AJUSTES</h1></div>
<div class="card"><div class="ct">EXPORTAR A EXCEL</div>
<div style="display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap" id="exPer"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px"><div class="fl" style="margin:0"><label>Desde</label><input type="date" id="exFrom"></div><div class="fl" style="margin:0"><label>Hasta</label><input type="date" id="exTo"></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><button class="btn bp" style="font-size:12px;padding:10px" onclick="exportXL('vias')">üì• V√≠as</button><button class="btn bp" style="font-size:12px;padding:10px;background:var(--yellow);color:#000" onclick="exportXL('entrenos')">üì• Entrenos</button></div>
<div id="exMsg" style="font-size:10px;margin-top:6px;text-align:center"></div>
</div>
<div class="card"><div class="ct">DATOS EN LA NUBE</div><p style="font-size:12px;color:var(--text2)"><span style="font-family:'Bebas Neue';font-size:22px;color:var(--green)" id="sN">0</span> registros guardados</p><p style="font-size:10px;color:var(--text3);margin-top:4px">Tus datos est√°n seguros en Firebase.</p></div>
<div class="card"><div class="ct">ACERCA DE</div><p style="font-size:11px;color:var(--text2)">Sube Pies v1.0 ¬∑ ¬© 2026 ¬∑ Todos los derechos reservados</p></div></div>
</div>
<!-- MODAL ROUTE --><div class="mbg" id="mR1"><div class="mdl"><button class="mx" onclick="cm('mR1')">‚úï</button><h2 id="mRT">V√çA</h2><div class="fl"><label>Nombre</label><input id="iN" placeholder="Diedro m√°gico"></div><div class="fl"><label>Lugar</label><input id="iL" placeholder="Atauri, Galdames..." list="dlZ"><datalist id="dlZ"></datalist></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div class="fl"><label>Tipo lugar</label><select id="iLT"><option value="roca">Roca</option><option value="indoor">Indoor</option></select></div><div class="fl"><label>Tipo v√≠a</label><select id="iTP"><option>Cuerda</option><option>Bloque</option><option>AutoAseg</option><option>Largos</option></select></div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px"><div class="fl"><label>Grado</label><select id="iG"></select></div><div class="fl"><label>Intento</label><select id="iI" onchange="chkFlashAvista()"></select></div><div class="fl"><label>Metros</label><input type="number" id="iMetros" placeholder="‚Äî" min="0" max="500" style="width:100%"></div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px"><div class="fl"><label>Encadenado</label><select id="iE" onchange="chkFlashAvista()"><option value="1">S√≠</option><option value="0">No</option></select></div><div class="fl" id="fFlash"><label>Flash</label><select id="iFlash"><option value="0">No</option><option value="1">S√≠</option></select></div><div class="fl" id="fAvista"><label>A vista</label><select id="iAvista"><option value="0">No</option><option value="1">S√≠</option></select></div></div><div class="fl"><label>Sensaciones</label><textarea id="iNo" placeholder="Beta, condiciones..."></textarea></div><div class="fl"><label>Compa√±eros</label><div id="rFriendChips" style="display:flex;gap:3px;flex-wrap:wrap;margin-bottom:4px"></div><input id="iA" placeholder="Escribe o elige amigos..." oninput="filterRouteFriends()"><div id="rFriendSug" style="display:none"></div></div><div class="fl"><label>Fecha</label><input type="date" id="iFe"></div><button class="btn bp" onclick="svR()">Guardar</button><button class="btn bdel" id="btnDelR" style="display:none" onclick="delR()">üóëÔ∏è Eliminar v√≠a</button><button class="btn bg2" onclick="cm('mR1')">Cancelar</button></div></div>
<!-- MODAL WORKOUT --><div class="mbg" id="mW1"><div class="mdl"><button class="mx" onclick="cm('mW1')">‚úï</button><h2 id="mW1Title">CREAR ENTRENO</h2><div class="fl"><label>Nombre</label><input id="wNm" placeholder="Fuerza dedos"></div><div class="fl"><label>Carpeta</label><select id="wFolder"><option value="">‚Äî Sin carpeta ‚Äî</option></select></div><div class="ct">PASOS</div><div id="wS"></div><div style="display:flex;gap:4px;margin-top:8px;margin-bottom:8px"><div class="ct" style="flex:1;margin:0">A√ëADIR</div><button class="ch on" style="font-size:10px" onclick="showEjForm()">üèã Ejercicio</button><button class="ch" style="font-size:10px" onclick="showViaForm()">üßó V√≠a</button></div><div style="display:flex;gap:3px;margin-bottom:8px;flex-wrap:wrap" id="ejTpls"></div><div id="ejForm" style="display:none;background:var(--bg3);border-radius:10px;padding:10px;margin-bottom:8px"><div class="fl"><label>Nombre</label><input id="ejNm" placeholder="Suspensiones, Dominadas..."></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px"><div class="fl"><label>Agarre</label><select id="ejAg"><option value="">‚Äî Ninguno ‚Äî</option><option>Regleta</option><option>Cazo</option><option>Pinza</option><option>Romo</option><option>Bidedo</option><option>Unidedo</option><option>Barra</option></select></div><div class="fl"><label>Tama√±o (mm)</label><input id="ejMm" type="number" placeholder="20"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px"><div class="fl"><label>√Ångulo</label><select id="ejAng"><option value="">‚Äî</option><option>0¬∞</option><option>15¬∞</option><option>30¬∞</option><option>45¬∞</option><option>90¬∞</option><option>120¬∞</option></select></div><div class="fl"><label>Lastre (kg)</label><input id="ejKg" type="number" value="0"></div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px"><div class="fl"><label>Modo</label><select id="ejModo" onchange="ejModoChg()"><option value="time">Tiempo</option><option value="reps">Reps</option></select></div><div class="fl" id="ejTimeF"><label>Tiempo (s)</label><input id="ejTime" type="number" value="7"></div><div class="fl" id="ejRepsF" style="display:none"><label>Reps</label><input id="ejReps" type="number" value="10"></div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px"><div class="fl"><label>Series</label><input id="ejSer" type="number" value="4"></div><div class="fl"><label>Reps/serie</label><input id="ejRep" type="number" value="6"></div><div class="fl"><label>Descanso (s)</label><input id="ejDesc" type="number" value="3"></div></div><div class="fl"><label>Desc. entre series (s)</label><input id="ejDS" type="number" value="180"></div><div style="display:flex;gap:4px"><button class="btn bp" style="flex:1;font-size:12px;padding:8px" onclick="addEj()">+ A√±adir</button><button class="btn bg2" style="width:auto;padding:8px 12px;font-size:10px;margin:0" onclick="saveCustomTpl()">üíæ Guardar plantilla</button></div></div><div id="viaForm" style="display:none;background:var(--bg3);border-radius:10px;padding:10px;margin-bottom:8px"><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px"><div class="fl"><label>Grado</label><select id="vfGrado"></select></div><div class="fl"><label>Tipo</label><select id="vfTipo"><option>Cuerda</option><option>Bloque</option><option>AutoAseg</option></select></div></div><div class="fl"><label>Nombre (opcional)</label><input id="vfNombre" placeholder="La rambla..."></div><button class="btn bp" style="font-size:12px;padding:8px" onclick="addViaStep()">+ A√±adir v√≠a</button></div><hr style="border:none;border-top:1px solid var(--bg4);margin:10px 0"><button class="btn bp" onclick="svW()">Guardar entreno</button><button class="btn bg2" onclick="cm('mW1')">Cancelar</button></div></div>
<!-- EJECUTOR --><div id="mExec" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);z-index:300;padding:0">
<div style="display:flex;flex-direction:column;height:100%;justify-content:center;align-items:center;padding:20px;text-align:center" id="exInner">
<button style="position:absolute;top:12px;right:16px;background:none;border:none;color:var(--text3);font-size:28px;cursor:pointer;z-index:2" onclick="stopExec()">‚úï</button>
<div id="exStep" style="font-family:'Bebas Neue';font-size:14px;color:var(--text3);letter-spacing:3px;margin-bottom:4px"></div>
<div id="exTitle" style="font-family:'Bebas Neue';font-size:32px;color:var(--rock);margin-bottom:4px"></div>
<div id="exDetail" style="font-size:12px;color:var(--rock);opacity:.7;margin-bottom:4px"></div>
<div id="exInfo" style="font-size:13px;color:var(--text2);margin-bottom:12px"></div>
<div id="exNextInfo" style="font-size:11px;color:var(--text3);margin-bottom:8px;display:none"></div>
<div id="exTimer" style="font-family:'Bebas Neue';font-size:120px;color:var(--green);line-height:1;margin:10px 0 20px"></div>
<div style="width:80%;max-width:300px;margin-bottom:24px"><div id="exProg" style="height:8px;background:var(--bg3);border-radius:4px;overflow:hidden"><div id="exBar" style="height:100%;background:var(--green);border-radius:4px;width:0%;transition:width .5s"></div></div></div>
<div id="exViaBtn" style="display:none;gap:12px;margin-bottom:16px"><button class="sbb" onclick="exViaDone(true)" style="font-size:16px;padding:14px 28px;background:var(--green)">‚úì Hecha</button><button class="sbb" onclick="exViaDone(false)" style="font-size:16px;padding:14px 28px;background:var(--red)">‚úï No</button></div>
<div style="display:flex;gap:12px;align-items:center"><button class="sbb" onclick="skipExec()" style="background:var(--bg3);color:var(--text2);font-size:13px;padding:12px 20px">‚èÆ</button><button class="sbb" id="exPlayBtn" onclick="toggleExec()" style="font-size:18px;padding:14px 36px;min-width:140px">‚ñ∂ EMPEZAR</button><button class="sbb" onclick="skipExec()" style="background:var(--bg3);color:var(--text2);font-size:13px;padding:12px 20px">‚è≠</button></div>
<label style="display:flex;align-items:center;gap:6px;margin-top:16px;font-size:12px;color:var(--text3);cursor:pointer"><input type="checkbox" id="exSound" checked style="accent-color:var(--rock)"> Sonido + vibraci√≥n</label>
</div></div>
<!-- MODAL PLAN --><div class="mbg" id="mPl"><div class="mdl"><button class="mx" onclick="cm('mPl')">‚úï</button><h2>PLANIFICAR D√çA</h2><div class="fl"><label>Fecha</label><input type="date" id="plDt"></div><div class="ct" style="margin-top:6px">¬øQU√â PLAN?</div><div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px"><button class="ch" id="plBtnEsc" onclick="setPlTipo('escalar')">üßó Escalar</button><button class="ch" id="plBtnEnt" onclick="setPlTipo('entreno')">üèã Entreno</button><button class="ch" id="plBtnNot" onclick="setPlTipo('nota')">üìù Nota</button></div><div id="plEscalar" style="display:none"><div class="fl"><label>Tipo</label><select id="plTp"><option value="roca">üèîÔ∏è Roca</option><option value="indoor">üè¢ Indoor</option></select></div><div class="fl"><label>Lugar</label><input id="plLg" placeholder="Atauri, Sharma..." list="dlZ"></div></div><div id="plEntreno" style="display:none"><div class="fl"><label>Carpeta</label><select id="plFolderSel" onchange="updPlWoList()"><option value="">‚Äî Todas ‚Äî</option></select></div><div class="fl"><label>Entreno</label><select id="plWoSel" onchange="updPlWoPreview()"><option value="">‚Äî Sin entreno ‚Äî</option></select></div><div id="plWoPreview" style="display:none;background:var(--bg3);border-radius:8px;padding:6px 8px;margin-bottom:8px;font-size:10px;color:var(--text2)"></div><div class="fl"><label><input type="checkbox" id="plShareWo" checked style="accent-color:var(--rock)"> Compartir ejercicios con invitados</label></div></div><div class="fl"><label>Notas</label><input id="plNo" placeholder="Plan del d√≠a..."></div><div class="ct" style="margin-top:6px">INVITAR AMIGOS</div><div class="fl"><input id="plFrSearch" placeholder="Buscar amigo..." oninput="filterPlFriends()" style="background:var(--bg3);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:7px 10px;color:var(--text);font-size:12px;font-family:Nunito;outline:none;width:100%;margin-bottom:4px"></div><div id="plFriends"></div><button class="btn bp" onclick="svPlan()">Guardar plan</button><button class="btn bg2" onclick="cm('mPl')">Cancelar</button></div></div>
<!-- MODAL NEW CRAG --><div class="mbg" id="mNC"><div class="mdl"><button class="mx" onclick="cm('mNC')">‚úï</button><h2>NUEVA ZONA</h2><p style="font-size:12px;color:var(--text2);margin-bottom:12px">En Google Maps ‚Üí busca el sitio ‚Üí pulsa largo ‚Üí copia las coordenadas que aparecen abajo (ej: 43.270854, -3.102539).</p><div class="fl"><label>Nombre de la zona</label><input id="ncNm" placeholder="Galdames"></div><div class="fl"><label>Coordenadas</label><input id="ncCoords" placeholder="43.270854, -3.102539"><small>Pega las coordenadas o la URL larga de Google Maps (la que tiene @43.27,-3.10)</small></div><div id="ncMsg" style="font-size:11px;margin-bottom:8px"></div><button class="btn bp" onclick="svNewCrag()">Guardar zona</button><button class="btn bg2" onclick="cm('mNC')">Cancelar</button></div></div>
<!-- MESOCICLO --><div class="mbg" id="mMeso"><div class="mdl"><button class="mx" onclick="cm('mMeso')">‚úï</button><h2>CREAR MESOCICLO</h2><div class="fl"><label>Nombre</label><input id="msNm" placeholder="Pre-temporada, Fuerza..."></div><div class="fl"><label>Fecha inicio</label><input type="date" id="msStart"></div><div class="ct">FASES</div><div id="msFases"></div><button class="btn bg2" style="font-size:11px;margin-bottom:10px" onclick="addFase()">+ A√±adir fase</button><div id="msPrev" style="display:none;margin-bottom:10px"></div><hr style="border:none;border-top:1px solid var(--bg4);margin:10px 0"><button class="btn bp" onclick="svMeso()">Guardar mesociclo</button><button class="btn bg2" onclick="cm('mMeso')">Cancelar</button></div></div>
<!-- NAV --><nav class="nav">
<button class="nb on" onclick="go('home')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l9-9 9 9M5 10v10a1 1 0 001 1h3m10-11v10a1 1 0 01-1 1h-3m-4 0v-6"/></svg>Inicio</button>
<button class="nb" onclick="go('routes')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>V√≠as</button>
<button class="nb" onclick="go('map')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>Mapa</button>
<button class="nb" onclick="go('train')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>Entrenos</button>
<button class="nb" onclick="go('friends')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>Amigos</button>
<button class="nb" onclick="go('sync')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Ajustes</button>
</nav>
<script>
firebase.initializeApp({apiKey:"AIzaSyBaBnTmI8_YuYIRGx2mdDVJSe_k4SF_eho",authDomain:"sube-pies.firebaseapp.com",projectId:"sube-pies",storageBucket:"sube-pies.firebasestorage.app",messagingSenderId:"597414564277",appId:"1:597414564277:web:1f79b81f567b67166c89fc"});
const auth=firebase.auth(),db=firebase.firestore();
let U=null,R=[],Tr=[],W=[],friends=[],plans=[],userCrags=[],mesos=[];

auth.onAuthStateChanged(async u=>{document.getElementById('loadPage').style.display='none';
  if(u){U=u;document.getElementById('loginPage').style.display='none';document.getElementById('appWrap').style.display='block';
    document.getElementById('uPic').src=u.photoURL||'';document.getElementById('uName').textContent=u.displayName||u.email;
    const code=parseInt(u.uid.replace(/[^0-9]/g,'').slice(0,4))||Math.floor(Math.random()*9000)+1000;
    await db.collection('users').doc(u.uid).set({name:u.displayName,email:u.email,photo:u.photoURL,code:code},{merge:true});
    document.getElementById('uTag').textContent='#'+code;
    await loadData();rH();}
  else{U=null;document.getElementById('loginPage').style.display='';document.getElementById('appWrap').style.display='none';}});
function loginGoogle(){auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());}
function logout(){auth.signOut();}

async function loadData(){if(!U)return;const uid=U.uid;
  let q=await db.collection('users').doc(uid).collection('routes').orderBy('date','desc').get();R=[];q.forEach(d=>{R.push({id:d.id,...d.data()});});
  q=await db.collection('users').doc(uid).collection('trains').orderBy('date','desc').get();Tr=[];q.forEach(d=>{Tr.push({id:d.id,...d.data()});});
  q=await db.collection('users').doc(uid).collection('workouts').get();W=[];q.forEach(d=>{W.push({id:d.id,...d.data()});});
  q=await db.collection('users').doc(uid).collection('friends').get();friends=[];q.forEach(d=>{friends.push({id:d.id,...d.data()});});
  for(const f of friends){try{const fq=await db.collection('users').where('email','==',f.email).get();
    if(!fq.empty){const ud=fq.docs[0].data();f.name=ud.name||f.email;f.photo=ud.photo||'';}}catch(e){}}
  q=await db.collection('users').doc(uid).collection('plans').get();plans=[];q.forEach(d=>{plans.push({id:d.id,...d.data()});});
  q=await db.collection('crags').get();userCrags=[];q.forEach(d=>{userCrags.push({id:d.id,...d.data()});});
  q=await db.collection('users').doc(uid).collection('mesos').get();mesos=[];q.forEach(d=>{mesos.push({id:d.id,...d.data()});});
  q=await db.collection('users').doc(uid).collection('woFolders').get();woFolders=[];q.forEach(d=>{woFolders.push({id:d.id,...d.data()});});
  updDL();}
function updDL(){const s=new Set();R.forEach(r=>{if(r.sitio)s.add(r.sitio);});let dl='';[...CRAGS.keys(),...userCrags.map(c=>c.name),...s].forEach(n=>{dl+=`<option value="${n}">`;});document.getElementById('dlZ').innerHTML=dl;}

async function saveRoute(data){if(!U)return;const col=db.collection('users').doc(U.uid).collection('routes');
  if(data.id&&data.id.length>5){await col.doc(data.id).set(data);const i=R.findIndex(r=>r.id===data.id);if(i>=0)R[i]=data;}
  else{const ref=await col.add(data);data.id=ref.id;R.unshift(data);}}
async function deleteRoute(id){if(!U)return;await db.collection('users').doc(U.uid).collection('routes').doc(id).delete();R=R.filter(r=>r.id!==id);}
async function saveTrain(data){if(!U)return;const ref=await db.collection('users').doc(U.uid).collection('trains').add(data);data.id=ref.id;Tr.unshift(data);}
async function saveWorkout(data){if(!U)return;const ref=await db.collection('users').doc(U.uid).collection('workouts').add(data);data.id=ref.id;W.push(data);}
async function delWorkout(id){if(!U)return;await db.collection('users').doc(U.uid).collection('workouts').doc(id).delete();W=W.filter(w=>w.id!==id);}
async function savePlan(data){if(!U)return;const ref=await db.collection('users').doc(U.uid).collection('plans').add(data);data.id=ref.id;plans.push(data);}
async function saveCrag(data){if(!U)return;const ref=await db.collection('crags').add(data);data.id=ref.id;userCrags.push(data);updDL();}

// CRAGS DB
const CRAGS=new Map([["Atauri",[42.77,-2.52]],["Etxauri",[42.83,-1.87]],["Riglos",[42.35,-0.72]],["Siurana",[41.25,0.93]],["Margalef",[41.28,0.75]],["Rodellar",[42.27,-0.08]],["Oliana",[42.07,1.31]],["Chulilla",[39.66,-0.89]],["Montanejos",[40.07,-0.53]],["Sella",[38.63,-0.27]],["Santa Linya",[41.98,0.76]],["Terradets",[42.07,0.84]],["El Chorro",[36.92,-4.77]],["Archidona",[37.09,-4.39]],["San Bartolo",[36.08,-5.63]],["O√±ati",[42.98,-2.41]],["Araotz",[42.97,-2.41]],["Leitza",[43.09,-1.90]],["Tres Ponts",[42.12,1.15]],["Kalymnos",[36.96,26.98]],["Leonidio",[37.16,22.86]],["Fontainebleau",[48.40,2.63]],["Ce√ºse",[44.50,5.95]],["Verdon",[43.75,6.40]],["Buoux",[43.82,5.38]],["Finale Ligure",[44.17,8.34]],["Arco",[45.92,10.88]],["Loja",[37.17,-4.15]],["Teverga",[43.15,-6.08]],["Pe√±√≥n de Ifach",[38.63,0.08]],["Albarrac√≠n",[40.41,-1.44]],["Cuenca",[40.06,-2.13]],["La Pedriza",[40.75,-3.87]],["Patones",[40.87,-3.57]],["Geyikbayiri",[37.15,30.48]],["Railay",[8.01,98.84]],["El Potrero Chico",[25.95,-100.47]],["Berdejo",[41.63,-1.93]],["Calcena",[41.63,-1.70]],["Morata de Jal√≥n",[41.48,-1.47]],["Baltzola",[43.14,-2.63]],["Aizkorri",[42.95,-2.35]]]);
function getCragCoords(name){if(!name)return null;const nl=name.toLowerCase();
  for(const[k,v]of CRAGS){if(nl.includes(k.toLowerCase()))return{name:k,lat:v[0],lng:v[1]};}
  for(const c of userCrags){if(nl.includes(c.name.toLowerCase()))return{name:c.name,lat:c.lat,lng:c.lng};}
  return null;}

const G=["V","6a","6a+","6b","6b+","6c","6c+","7a","7a+","7b","7b+","7c","7c+","8a","8a+","8b","8b+","8c","8c+","9a","9a+","9b","9b+","9c"];
let cY=2026,cMo=1,cSl=null,gM='cr',gPer='year',sPer='year',rFl='all',tTb='plan',mapMode='roca',eRt=null,wSt=[],leafMap=null,markers=[],chatUnsub=null,chatFrUid=null;
const PG={home:'ph',routes:'pv',map:'pm',train:'pt',friends:'pf',sync:'ps'},PK=Object.keys(PG);
function go(id){Object.values(PG).forEach(p=>document.getElementById(p).classList.remove('on'));document.querySelectorAll('.nb').forEach(b=>b.classList.remove('on'));document.getElementById(PG[id]).classList.add('on');document.querySelectorAll('.nb')[PK.indexOf(id)].classList.add('on');const fns={home:rH,routes:drR,map:drM,train:drTr,friends:drFr,sync:drS};if(fns[id])fns[id]();}
function drS(){const el=document.getElementById('sN');if(el)el.textContent=D.length;}

// HOME
function rH(){updStats();rCal();updGrToggles();loadInvites();setupSwipe();}
function drCalDetail(){
  const el=document.getElementById('calDetail');
  const sel=cSl||new Date().toISOString().split('T')[0];
  const dp=plans.filter(p=>p.date===sel);
  const dr=R.filter(r=>r.date===sel);
  const dt=Tr.filter(t=>t.date===sel);
  const dw=W.filter(w=>w.plannedDate===sel);
  const dd=new Date(sel);
  let h=`<div style="background:var(--bg2);border-radius:0 0 12px 12px;padding:10px 12px;border:1px solid rgba(255,255,255,.04);border-top:none">`;
  h+=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-family:'Bebas Neue';font-size:15px;color:var(--text)">${dd.toLocaleDateString('es-ES',{weekday:'long',day:'numeric',month:'long'})}</span><button class="sbb" style="font-size:12px;padding:7px 18px" onclick="openPlan('${sel}')">+ Planificar</button></div>`;
  // Plans (with delete)
  dp.forEach(p=>{
    let icon=p.tipo==='roca'?'üèîÔ∏è':p.tipo==='indoor'?'üè¢':p.tipo==='entreno'?'üèã':'üìù';
    h+=`<div style="font-size:11px;padding:3px 0;display:flex;align-items:center;gap:4px">${icon} `;
    if(p.lugar)h+=`<span>${p.lugar}</span> `;
    if(p.workoutName)h+=`<span style="color:var(--green)">${p.workoutName}</span> `;
    if(p.notas)h+=`<span style="color:var(--text3)">${p.notas}</span> `;
    if(p.invited&&p.invited.length){const names=p.invited.map(e=>{const f=friends.find(fr=>fr.email===e);return f?(f.name||e):e;});
      h+=`<span style="color:var(--blue)">üë• ${names.join(', ')}</span> `;}
    h+=`<button style="background:none;border:none;color:var(--red);font-size:12px;cursor:pointer;margin-left:auto;flex-shrink:0" onclick="delPlan('${p.id}')">‚úï</button></div>`;});
  // Workouts planned
  dw.forEach(w=>{
    h+=`<div style="font-size:11px;padding:2px 0;color:var(--purple)">üèã ${w.name}</div>`;});
  // Routes as compact table
  if(dr.length){
    h+=`<table style="width:100%;border-collapse:collapse;font-size:11px;margin-top:2px">`;
    dr.forEach(r=>{
      const gc=r.enc?'var(--green)':'var(--rock)';
      const loc=r.lugar==='roca'?'üèî':'üè¢';
      h+=`<tr style="border-bottom:1px solid rgba(255,255,255,.03)"><td style="padding:2px 0;width:36px"><span style="color:${gc};font-family:'Bebas Neue';font-size:13px">${r.grado}</span></td><td style="padding:2px 4px;color:var(--text2)">${r.tipo}</td><td style="padding:2px 4px">${loc}</td><td style="padding:2px 0;color:var(--text3)">${r.enc?'‚úì':''}${r.flash?' ‚ö°':''}${r.avista?' üëÅ':''}${r.metros?r.metros+'m':''}${r.nombre?' '+r.nombre:''}</td></tr>`;});
    h+=`</table>`;}
  // Trainings done
  dt.forEach(t=>{h+=`<div style="font-size:10px;color:var(--yellow);padding:2px 0">üèã ${t.detail||t.tipo}</div>`;});
  if(!dp.length&&!dr.length&&!dt.length&&!dw.length){h+=`<div style="font-size:11px;color:var(--text3);padding:4px 0">Sin actividad</div>`;}
  h+='</div>';el.innerHTML=h;}
async function delPlan(planId){
  const p=plans.find(x=>x.id===planId);if(!p)return;
  if(!confirm('¬øEliminar este plan?'))return;
  // If shared, notify invited friends
  if(p.invited&&p.invited.length&&U){
    const fromName=U.displayName||U.email;
    for(const email of p.invited){
      try{const q=await db.collection('users').where('email','==',email).get();
        if(!q.empty){const fuid=q.docs[0].id;
          await db.collection('users').doc(fuid).collection('invites').add({
            from:U.uid,fromName,date:p.date,tipo:'cancelacion',
            lugar:p.lugar||'',notas:fromName+' ha cancelado: '+(p.workoutName||p.lugar||p.notas||'plan'),
            status:'pending',ts:firebase.firestore.FieldValue.serverTimestamp(),type:'cancel'});}}catch(e){}}}
  await db.collection('users').doc(U.uid).collection('plans').doc(planId).delete();
  plans=plans.filter(x=>x.id!==planId);rCal();}
let nwoIdx=-1; // Index into workout days, -1 = auto
function drNextWo(){
  const td=new Date().toISOString().split('T')[0];
  const el=document.getElementById('homeNextWo');
  const dates=[...new Set(W.filter(w=>w.plannedDate).map(w=>w.plannedDate))].sort();
  if(!dates.length){el.innerHTML=`<div style="text-align:center;padding:12px"><span style="color:var(--text3);font-size:12px">Sin entrenos programados</span></div>`;return;}
  // Auto: find nearest future date
  if(nwoIdx<0){nwoIdx=dates.findIndex(d=>d>=td);if(nwoIdx<0)nwoIdx=dates.length-1;}
  if(nwoIdx>=dates.length)nwoIdx=0;if(nwoIdx<0)nwoIdx=dates.length-1;
  const nxtDate=dates[nwoIdx];
  const dw=W.filter(w=>w.plannedDate===nxtDate);
  const dd=new Date(nxtDate);
  const isToday=nxtDate===td;
  const tmr=new Date();tmr.setDate(tmr.getDate()+1);const isTmr=nxtDate===tmr.toISOString().split('T')[0];
  const dayLabel=dd.toLocaleDateString('es-ES',{weekday:'long',day:'numeric',month:'long'});
  const isClose=isToday||isTmr;
  const extra=isToday?' ¬∑ HOY':isTmr?' ¬∑ MA√ëANA':'';
  
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-family:'Bebas Neue';font-size:13px;color:var(--text3);letter-spacing:1px">ENTRENO ¬∑ <span style="color:${isClose?'var(--green)':'var(--rock)'}"> ${dayLabel.toUpperCase()}${extra}</span></span>`;
  if(dates.length>1)h+=`<span style="font-size:10px;color:var(--text3)">${nwoIdx+1}/${dates.length} ‚óÄ ‚ñ∂</span>`;
  h+=`</div>`;
  dw.forEach(w=>{
    h+=`<div style="background:rgba(76,175,80,.06);border-radius:8px;padding:8px;margin-bottom:4px;border-left:3px solid var(--green)">`;
    h+=`<div style="font-family:'Bebas Neue';font-size:16px;color:var(--green);margin-bottom:4px">${w.name}</div>`;
    (w.steps||[]).forEach((s,i)=>{let nm=s.nm||s.txt||'';const pts=[];
      if(s.ag)pts.push(s.ag);if(s.mm)pts.push(s.mm+'mm');if(s.kg>0)pts.push('+'+s.kg+'kg');if(s.ang)pts.push(s.ang);
      if(s.modo==='time')pts.push(s.time+'s√ó'+(s.rep||1)+'r√ó'+(s.ser||1)+'ser');
      else if(s.reps)pts.push(s.reps+'r√ó'+(s.ser||1)+'ser');
      h+=`<div style="font-size:11px;color:var(--text2);padding:1px 0">${i+1}. ${nm}${pts.length?' ¬∑ '+pts.join(' ¬∑ '):''}</div>`;});
    h+=`<div style="margin-top:6px"><button class="sbb" style="font-size:11px;padding:5px 12px" onclick='execWo(${JSON.stringify(w).replace(/'/g,"&#39;")})'>‚ñ∂ Ejecutar</button></div></div>`;});
  el.innerHTML=h;}
let _swipeSetup=false;
function setupSwipe(){if(_swipeSetup)return;_swipeSetup=true;let sx=0;
  document.addEventListener('touchstart',e=>{if(e.target.closest('#homeNextWo'))sx=e.touches[0].clientX;else sx=0;},{passive:true});
  document.addEventListener('touchend',e=>{if(!sx||!e.target.closest('#homeNextWo'))return;
    const dx=e.changedTouches[0].clientX-sx;sx=0;
    if(Math.abs(dx)>40){if(dx<0)nwoIdx++;else nwoIdx--;drNextWo();}});}
// Bolt (disabled for now)
// Settings (Bolt disabled)
function getSettings(){return JSON.parse(localStorage.getItem('spSettings')||'{}');}
async function loadInvites(){if(!U)return;
  const q=await db.collection('users').doc(U.uid).collection('invites').where('status','==','pending').get();
  let h='';q.forEach(d=>{const inv=d.data();const tipos={roca:'üèîÔ∏è Roca',indoor:'üè¢ Indoor',entreno:'üèãÔ∏è Entreno',nota:'üìù Nota',cancelacion:'‚ùå Cancelaci√≥n'};
    const dd=new Date(inv.date).toLocaleDateString('es-ES',{weekday:'short',day:'numeric',month:'short'});
    let detail=tipos[inv.tipo]||inv.tipo;
    if(inv.lugar)detail+=' ¬∑ '+inv.lugar;
    if(inv.workoutName)detail+=' ¬∑ üèã '+inv.workoutName;
    if(inv.type==='cancel'){
      h+=`<div class="inv-card" style="border-color:var(--red);background:linear-gradient(135deg,rgba(255,107,107,.15),rgba(255,107,107,.05))"><div class="inv-who" style="color:var(--red)">‚ùå ${inv.fromName} ha cancelado</div><div class="inv-det">${inv.notas||detail} ¬∑ ${dd}</div><div class="inv-btns"><button class="inv-yes" onclick="answerInv('${d.id}','accepted')">OK, mantener mi plan</button><button class="inv-no" onclick="answerInv('${d.id}','rejected')">Eliminar mi plan</button></div></div>`;
    }else{
      h+=`<div class="inv-card"><div class="inv-who">${inv.fromName} te invita</div><div class="inv-det">${detail} ¬∑ ${dd}</div>${inv.notas?`<div style="font-size:10px;color:var(--text3)">${inv.notas}</div>`:''}<div class="inv-btns"><button class="inv-yes" onclick="answerInv('${d.id}','accepted')">‚úì Aceptar</button><button class="inv-no" onclick="answerInv('${d.id}','rejected')">‚úï Rechazar</button></div></div>`;}});
  document.getElementById('invBanner').innerHTML=h;}
async function answerInv(id,status){if(!U)return;
  const ref=db.collection('users').doc(U.uid).collection('invites').doc(id);
  const doc=await ref.get();if(!doc.exists)return;const inv=doc.data();
  await ref.update({status});
  if(status==='accepted'){
    const plan={date:inv.date,tipo:inv.tipo,lugar:inv.lugar||'',notas:'Con '+inv.fromName};
    if(inv.workoutName)plan.workoutName=inv.workoutName;
    if(inv.workoutSteps){plan.workoutSteps=inv.workoutSteps;
      // Also save as a workout for the user
      await saveWorkout({name:inv.workoutName+' (de '+inv.fromName+')',steps:inv.workoutSteps,plannedDate:inv.date});}
    await savePlan(plan);}
  loadInvites();rCal();}
function updStats(){const y=new Date().getFullYear(),yr=R.filter(r=>new Date(r.date).getFullYear()===y);
  let sp='';[['year','A√±o'],['life','Siempre']].forEach(([k,lb])=>{sp+=`<button class="gp${sPer===k?' on':''}" onclick="sPer='${k}';updStats()">${lb}</button>`;});
  document.getElementById('sPer').innerHTML=sp;
  const sr=sPer==='year'?yr:R;const st=sPer==='year'?Tr.filter(t=>new Date(t.date).getFullYear()===y):Tr;
  document.getElementById('sV').textContent=sr.length;document.getElementById('sE').textContent=sr.filter(r=>r.enc).length;
  document.getElementById('sT').textContent=st.length;
  document.getElementById('sVl').textContent='V√≠as';
  document.getElementById('sEl').textContent='Encadenes';
  document.getElementById('sTl').textContent='Entrenos';}
function updGrToggles(){
  let gp='';[['year','A√±o'],['life','Siempre']].forEach(([k,lb])=>{gp+=`<button class="gp${gPer===k?' on':''}" onclick="gPer='${k}';rGr();updGrToggles()">${lb}</button>`;});
  document.getElementById('gPer').innerHTML=gp;
  let gs='';[['all','Todas'],['cr','Cuerda Roca'],['br','Bloq Roco'],['cro','Cuerda Roco'],['ar','Auto Roco']].forEach(([k,lb])=>{gs+=`<button class="gs${gM===k?' on':''}" onclick="gM='${k}';rGr();updGrToggles()">${lb}</button>`;});
  document.getElementById('gS').innerHTML=gs;rGr();}
function rCal(){const mN=["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];
  document.getElementById('cM').textContent=mN[cMo]+' '+cY;const f=new Date(cY,cMo,1);let sd=f.getDay();if(sd===0)sd=7;sd--;const dm=new Date(cY,cMo+1,0).getDate(),td=new Date();
  let h='';['L','M','X','J','V','S','D'].forEach(d=>{h+=`<div class="cdh">${d}</div>`;});
  for(let i=0;i<sd;i++)h+='<div class="cd emp"></div>';
  for(let d=1;d<=dm;d++){const ds=`${cY}-${String(cMo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dr=R.filter(r=>r.date===ds),hr=dr.some(r=>r.lugar==='roca'),hc=dr.some(r=>r.lugar==='indoor'||r.lugar==='roco'),ht=Tr.some(t=>t.date===ds);
    const hp=plans.some(p=>p.date===ds),hwk=W.some(w=>w.plannedDate===ds);
    const it=d===td.getDate()&&cMo===td.getMonth()&&cY===td.getFullYear();
    let c='cd';if(it)c+=' tod';if(hr&&hc)c+=' hb';else if(hr)c+=' hr';else if(hc)c+=' hc';
    if(ht)c+=' ht';if(hp&&!hr&&!hc)c+=' plan';if(hwk&&!hr&&!hc&&!hp)c+=' hw';if(cSl===ds)c+=' sel';
    const mc=getMesoColor(ds);const mStyle=mc&&!hr&&!hc?` style="background:${mc}22;border:1px solid ${mc}44"`:'';
    h+=`<div class="${c}"${mStyle} onclick="cSl=cSl==='${ds}'?null:'${ds}';rCal()">${d}</div>`;}
  document.getElementById('cG').innerHTML=h;
  drCalDetail();drNextWo();}
function cNav(d){cMo+=d;if(cMo>11){cMo=0;cY++;}if(cMo<0){cMo=11;cY--;}rCal();}
function rGr(){const y=new Date().getFullYear();
  const base=gPer==='year'?R.filter(r=>new Date(r.date).getFullYear()===y):R;
  let f;
  if(gM==='all')f=base;
  else if(gM==='cr')f=base.filter(r=>r.lugar==='roca'&&r.tipo==='Cuerda');
  else if(gM==='br')f=base.filter(r=>(r.lugar==='indoor'||r.lugar==='roco')&&r.tipo==='Bloque');
  else if(gM==='cro')f=base.filter(r=>(r.lugar==='indoor'||r.lugar==='roco')&&r.tipo==='Cuerda');
  else f=base.filter(r=>(r.lugar==='indoor'||r.lugar==='roco')&&r.tipo==='AutoAseg');
  const c={};f.forEach(r=>{c[r.grado]=(c[r.grado]||0)+1;});const s=Object.entries(c).sort((a,b)=>G.indexOf(b[0])-G.indexOf(a[0]));
  const mx=Math.max(...s.map(x=>x[1]),1);
  const cc=(gM==='br'||gM==='cro'||gM==='ar')?'ro':(gM==='all'?'rc':'rc');
  let h=`<div style="font-size:11px;color:var(--text2);margin-bottom:6px">${f.length} v√≠as${gPer==='year'?' este a√±o':' en total'}</div>`;
  s.slice(0,10).forEach(([g,n])=>{h+=`<div class="gr"><div class="grn">${g}</div><div class="grb"><div class="grf ${cc}" style="width:${(n/mx)*100}%">${n}</div></div></div>`;});
  document.getElementById('gB').innerHTML=h||'<div style="color:var(--text3);font-size:12px;padding:10px">Sin datos</div>';}
let plTipo='escalar';
function setPlTipo(t){plTipo=t;
  document.getElementById('plEscalar').style.display=t==='escalar'?'block':'none';
  document.getElementById('plEntreno').style.display=t==='entreno'?'block':'none';
  document.querySelectorAll('#plBtnEsc,#plBtnEnt,#plBtnNot').forEach(b=>b.classList.remove('on'));
  document.getElementById(t==='escalar'?'plBtnEsc':t==='entreno'?'plBtnEnt':'plBtnNot').classList.add('on');}
function openPlan(dt){document.getElementById('plDt').value=dt;document.getElementById('plLg').value='';document.getElementById('plNo').value='';
  document.getElementById('plFrSearch').value='';
  plTipo='escalar';setPlTipo('escalar');
  // Populate folder selector
  let fh='<option value="">‚Äî Todas ‚Äî</option>';
  woFolders.forEach(f=>{fh+=`<option value="${f.id}">${f.name}</option>`;});
  document.getElementById('plFolderSel').innerHTML=fh;
  updPlWoList();
  // Populate friends
  drPlFriends('');
  document.getElementById('plWoPreview').style.display='none';
  document.getElementById('mPl').classList.add('sh');}
function updPlWoList(){
  const fId=document.getElementById('plFolderSel').value;
  const fW=fId?W.filter(w=>w.folder===fId):W;
  let wh='<option value="">‚Äî Sin entreno ‚Äî</option>';
  fW.forEach(w=>{wh+=`<option value="${w.id}">${w.name}</option>`;});
  document.getElementById('plWoSel').innerHTML=wh;
  document.getElementById('plWoPreview').style.display='none';}
function updPlWoPreview(){
  const woId=document.getElementById('plWoSel').value;
  const prev=document.getElementById('plWoPreview');
  if(!woId){prev.style.display='none';return;}
  const w=W.find(x=>x.id===woId);
  if(!w){prev.style.display='none';return;}
  let h='';(w.steps||[]).forEach((s,i)=>{let d=s.nm||s.txt||'?';const pts=[];
    if(s.ag)pts.push(s.ag);if(s.mm)pts.push(s.mm+'mm');if(s.kg>0)pts.push('+'+s.kg+'kg');
    if(s.modo==='time')pts.push(s.time+'s√ó'+(s.rep||1)+'r√ó'+(s.ser||1)+'ser');
    else if(s.reps)pts.push(s.reps+'r√ó'+(s.ser||1)+'ser');
    h+=`<div style="padding:1px 0">${i+1}. ${d}${pts.length?' ¬∑ '+pts.join(' ¬∑ '):''}</div>`;});
  prev.innerHTML=h;prev.style.display='block';}
function drPlFriends(q){
  let fh='';if(!friends.length){fh='<div style="font-size:10px;color:var(--text3);padding:4px">Sin amigos a√∫n</div>';}
  else{const ql=q.toLowerCase();
    friends.forEach(f=>{const nm=f.name||f.email;
      if(ql&&!nm.toLowerCase().includes(ql))return;
      fh+=`<label style="display:flex;align-items:center;gap:6px;padding:5px 0;font-size:12px;cursor:pointer"><input type="checkbox" class="plFrCb" value="${f.email}" data-name="${nm}" style="accent-color:var(--rock)"><img src="${f.photo||''}" style="width:24px;height:24px;border-radius:50%;border:1px solid var(--bg3)" onerror="this.style.display='none'">${nm}</label>`;});}
  document.getElementById('plFriends').innerHTML=fh;}
function filterPlFriends(){const q=document.getElementById('plFrSearch').value||'';
  // Save checked state
  const checked=new Set();document.querySelectorAll('.plFrCb:checked').forEach(cb=>checked.add(cb.value));
  drPlFriends(q);
  // Restore checked
  document.querySelectorAll('.plFrCb').forEach(cb=>{if(checked.has(cb.value))cb.checked=true;});}
async function svPlan(){const date=document.getElementById('plDt').value,notas=document.getElementById('plNo').value;
  if(!date){alert('Pon una fecha');return;}
  let tipo,lugar='',woData=null;
  if(plTipo==='escalar'){
    tipo=document.getElementById('plTp').value;
    lugar=document.getElementById('plLg').value;
  }else if(plTipo==='entreno'){
    tipo='entreno';
    const woId=document.getElementById('plWoSel').value;
    if(woId){woData=W.find(x=>x.id===woId);}
  }else{tipo='nota';}
  const invited=[];
  document.querySelectorAll('.plFrCb:checked').forEach(cb=>{invited.push(cb.value);});
  const shareWo=document.getElementById('plShareWo')&&document.getElementById('plShareWo').checked;
  const plan={date,tipo:tipo||'nota',lugar,notas,invited};
  if(woData){plan.workoutName=woData.name;if(shareWo)plan.workoutSteps=woData.steps;
    if(woData.id){await db.collection('users').doc(U.uid).collection('workouts').doc(woData.id).update({plannedDate:date});woData.plannedDate=date;}}
  await savePlan(plan);
  // Send invites to each friend
  if(invited.length&&U){
    const fromName=U.displayName||U.email;
    for(const email of invited){
      try{const q=await db.collection('users').where('email','==',email).get();
      if(!q.empty){const fuid=q.docs[0].id;
        const inv={from:U.uid,fromName,fromEmail:U.email,date,tipo:tipo||'nota',lugar,notas,status:'pending',ts:firebase.firestore.FieldValue.serverTimestamp()};
        if(woData){inv.workoutName=woData.name;if(shareWo)inv.workoutSteps=woData.steps;inv.type='workout';}
        else inv.type='plan';
        await db.collection('users').doc(fuid).collection('invites').add(inv);}}catch(e){console.error('Invite error:',e);}}}
  cm('mPl');rCal();}

// ROUTES
let vMo='';
function drR(){let fc='';[['all','Todas'],['roca','Roca'],['indoor','Indoor'],['enc','Enc'],['cuerda','Cuerda'],['bloque','Bloque'],['auto','AutoAseg']].forEach(([k,lb])=>{fc+=`<button class="ch${rFl===k?' on':''}" onclick="rFl='${k}';drR()">${lb}</button>`;});document.getElementById('rF').innerHTML=fc;
  const q=(document.getElementById('vQ').value||'').trim().toLowerCase();
  let fl=R.slice();if(rFl==='roca')fl=fl.filter(r=>r.lugar==='roca');if(rFl==='indoor')fl=fl.filter(r=>r.lugar==='indoor'||r.lugar==='roco');if(rFl==='enc')fl=fl.filter(r=>r.enc);if(rFl==='cuerda')fl=fl.filter(r=>r.tipo==='Cuerda');if(rFl==='bloque')fl=fl.filter(r=>r.tipo==='Bloque');if(rFl==='auto')fl=fl.filter(r=>r.tipo==='AutoAseg');
  if(q)fl=fl.filter(r=>(r.nombre||'').toLowerCase().includes(q)||(r.sitio||'').toLowerCase().includes(q)||(r.amigos||'').toLowerCase().includes(q)||(r.grado||'').toLowerCase().includes(q)||(r.tipo||'').toLowerCase().includes(q)||(r.date||'').includes(q));
  const so=document.getElementById('rS').value;if(so==='date')fl.sort((a,b)=>b.date.localeCompare(a.date));if(so==='dateA')fl.sort((a,b)=>a.date.localeCompare(b.date));if(so==='grD')fl.sort((a,b)=>G.indexOf(b.grado)-G.indexOf(a.grado));if(so==='grA')fl.sort((a,b)=>G.indexOf(a.grado)-G.indexOf(b.grado));if(so==='lugar')fl.sort((a,b)=>(a.sitio||'').localeCompare(b.sitio||''));if(so==='amigo')fl.sort((a,b)=>(a.amigos||'').localeCompare(b.amigos||''));
  // Month dropdown (only when not searching)
  const mos=[...new Set(fl.map(r=>(r.date||'').substring(0,7)).filter(Boolean))].sort().reverse();
  if(!vMo&&mos.length)vMo=mos[0];
  if(!q&&mos.length>1){
    let md='<select id="vMoSel" onchange="vMo=this.value;drR()" style="width:100%;background:var(--bg3);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px;color:var(--text);font-size:13px;font-family:Nunito;margin-bottom:6px">';
    md+='<option value="all"'+(vMo==='all'?' selected':'')+'>Todos los meses ('+fl.length+')</option>';
    mos.forEach(m=>{const d=new Date(m+'-01');const lb=d.toLocaleDateString('es-ES',{month:'long',year:'numeric'});const cnt=fl.filter(r=>(r.date||'').startsWith(m)).length;
      md+=`<option value="${m}"${m===vMo?' selected':''}>${lb.charAt(0).toUpperCase()+lb.slice(1)} (${cnt})</option>`;});
    md+='</select>';document.getElementById('rL').insertAdjacentHTML('beforebegin','');
    // Filter by month
    if(vMo&&vMo!=='all')fl=fl.filter(r=>(r.date||'').startsWith(vMo));
    let h=md;
    fl.forEach(r=>{h+=vc(r,true);});
    document.getElementById('rL').innerHTML=h||'<div style="text-align:center;color:var(--text3);padding:30px">Sin v√≠as</div>';
  }else{
    let h='';
    fl.forEach(r=>{h+=vc(r,true);});
    document.getElementById('rL').innerHTML=h||'<div style="text-align:center;color:var(--text3);padding:30px">Sin v√≠as</div>';}}
function vc(r,ed){return `<div class="via ${r.enc?'enc':''}" ${ed?`onclick="edR('${r.id}')"`:''}><div class="vt"><div class="vg">${r.grado}</div><div class="vd">${new Date(r.date).toLocaleDateString('es-ES',{day:'numeric',month:'short'})}</div></div>${r.nombre?`<div class="vn">${r.nombre}</div>`:''}${r.sitio?`<div class="vl">üìç ${r.sitio}</div>`:''}<div class="vts"><span class="tg r">${r.lugar==='roca'?'Roca':'Indoor'}</span><span class="tg t">${r.tipo}</span>${r.metros?`<span class="tg">${r.metros}m</span>`:''}<span class="tg">Int:${r.intento||1}</span>${r.enc?'<span class="tg e">Enc ‚úì</span>':''}${r.amigos?`<span class="tg">üë• ${r.amigos}</span>`:''}${r.notas?'<span class="tg">üí¨</span>':''}</div></div>`;}
function pSel(){const g=document.getElementById('iG');g.innerHTML='';G.forEach(x=>{g.innerHTML+=`<option>${x}</option>`;});const i=document.getElementById('iI');i.innerHTML='';for(let j=1;j<=9;j++)i.innerHTML+=`<option>${j}</option>`;}
function addR(){eRt=null;document.getElementById('mRT').textContent='NUEVA V√çA';pSel();['iN','iL','iNo','iA'].forEach(id=>document.getElementById(id).value='');document.getElementById('iMetros').value='';document.getElementById('iFe').value=new Date().toISOString().split('T')[0];document.getElementById('iG').value='7a';document.getElementById('iE').value='0';document.getElementById('btnDelR').style.display='none';document.getElementById('mR1').classList.add('sh');}
function edR(id){const r=R.find(x=>x.id===id);if(!r)return;eRt=id;document.getElementById('mRT').textContent='EDITAR V√çA';pSel();document.getElementById('iN').value=r.nombre||'';document.getElementById('iL').value=r.sitio||'';document.getElementById('iLT').value=r.lugar;document.getElementById('iTP').value=r.tipo;document.getElementById('iG').value=r.grado;document.getElementById('iI').value=r.intento||1;document.getElementById('iE').value=r.enc?'1':'0';document.getElementById('iNo').value=r.notas||'';document.getElementById('iA').value=r.amigos||'';document.getElementById('iFe').value=r.date;document.getElementById('iMetros').value=r.metros||'';document.getElementById('btnDelR').style.display='block';document.getElementById('mR1').classList.add('sh');}
async function svR(){const int=parseInt(document.getElementById('iI').value)||1;const enc=document.getElementById('iE').value==='1';
  const flash=enc&&int===1&&document.getElementById('iFlash').value==='1';
  const avista=enc&&int===1&&document.getElementById('iAvista').value==='1';
  const amigos=document.getElementById('iA').dataset.selected||document.getElementById('iA').value;
  const metros=parseInt(document.getElementById('iMetros').value)||0;
  const d={date:document.getElementById('iFe').value,lugar:document.getElementById('iLT').value,tipo:document.getElementById('iTP').value,grado:document.getElementById('iG').value,intento:int,enc,flash,avista,nombre:document.getElementById('iN').value,sitio:document.getElementById('iL').value,notas:document.getElementById('iNo').value,amigos,metros};if(eRt)d.id=eRt;await saveRoute(d);cm('mR1');drR();rH();}
async function delR(){if(!eRt||!confirm('¬øEliminar esta v√≠a?'))return;await deleteRoute(eRt);cm('mR1');drR();}
function cm(id){document.getElementById(id).classList.remove('sh');if(id==='mNC')document.getElementById('mapDiv').style.display='block';}

// MAP
function drM(){let tb='';[['roca','üèîÔ∏è Roca'],['roco','üè¢ Roc√≥dromo']].forEach(([k,lb])=>{tb+=`<button class="tb${mapMode===k?' on':''}" onclick="mapMode='${k}';drM()">${lb}</button>`;});document.getElementById('mapTbs').innerHTML=tb;
  const rr=mapMode==='roca'?R.filter(r=>r.lugar==='roca'):R.filter(r=>r.lugar==='indoor'||r.lugar==='roco');
  document.getElementById('mTotal').textContent=rr.length;document.getElementById('mEnc').textContent=rr.filter(r=>r.enc).length;
  const locs=buildLocs(rr);document.getElementById('mZonas').textContent=Object.keys(locs).length;
  if(!leafMap){leafMap=L.map('mapDiv',{zoomControl:false}).setView([40.4,-2.5],5);L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'¬©OSM',maxZoom:18}).addTo(leafMap);L.control.zoom({position:'topright'}).addTo(leafMap);}
  markers.forEach(m=>leafMap.removeLayer(m));markers=[];const bounds=[],col=mapMode==='roca'?'#d4a574':'#4ecdc4';
  Object.values(locs).forEach(l=>{const sz=Math.min(8+l.rs.length*3,28);const icon=L.divIcon({className:'',html:`<div style="width:${sz}px;height:${sz}px;background:${col};border-radius:50%;border:2px solid #fff;opacity:.9;display:flex;align-items:center;justify-content:center;font-size:${Math.max(9,sz/2.5)}px;font-weight:700;color:#000;font-family:Nunito">${l.rs.length}</div>`,iconSize:[sz,sz],iconAnchor:[sz/2,sz/2]});const m=L.marker([l.lat,l.lng],{icon}).addTo(leafMap);m.bindPopup(`<b style="font-family:'Bebas Neue';font-size:14px;color:${col}">${l.name}</b><br>${l.rs.length} v√≠as ¬∑ ${l.enc} enc.`);m.on('click',()=>showZone(l));markers.push(m);bounds.push([l.lat,l.lng]);});
  if(bounds.length>1)leafMap.fitBounds(bounds,{padding:[20,20]});else if(bounds.length===1)leafMap.setView(bounds[0],10);
  setTimeout(()=>leafMap.invalidateSize(),100);document.getElementById('mRt').innerHTML='';document.getElementById('mapResults').style.display='none';document.getElementById('mapQ').value='';}
function buildLocs(rr){const locs={};rr.forEach(r=>{if(!r.sitio)return;const c=getCragCoords(r.sitio);if(c){if(!locs[c.name])locs[c.name]={...c,rs:[],enc:0};locs[c.name].rs.push(r);if(r.enc)locs[c.name].enc++;}});return locs;}
function showZone(l){let h=`<div style="font-family:'Bebas Neue';font-size:16px;color:var(--rock);margin:8px 0">${l.name} ‚Äî ${l.rs.length} v√≠as (${l.enc} enc.)</div>`;l.rs.forEach(r=>{h+=vc(r,true);});document.getElementById('mRt').innerHTML=h;}
function filterMap(){const q=document.getElementById('mapQ').value.trim().toLowerCase();if(!q){document.getElementById('mapResults').style.display='none';return;}
  const rr=mapMode==='roca'?R.filter(r=>r.lugar==='roca'):R.filter(r=>r.lugar==='indoor'||r.lugar==='roco');const locs=buildLocs(rr);const match=Object.values(locs).filter(l=>l.name.toLowerCase().includes(q));
  if(match.length===1){leafMap.setView([match[0].lat,match[0].lng],10);showZone(match[0]);document.getElementById('mapResults').style.display='none';}
  else if(match.length>1){let h='';match.forEach(l=>{h+=`<div class="fr-card" style="cursor:pointer" onclick="leafMap.setView([${l.lat},${l.lng}],10);showZone(mapLocs['${l.name}'])"><div class="fr-info"><div class="fr-name" style="color:var(--rock)">${l.name}</div><div class="fr-email">${l.rs.length} v√≠as</div></div></div>`;});
    document.getElementById('mapResults').innerHTML=h;document.getElementById('mapResults').style.display='block';window.mapLocs={};match.forEach(l=>{window.mapLocs[l.name]=l;});}
  else{document.getElementById('mapResults').innerHTML='<div style="color:var(--text3);font-size:11px;padding:8px">No encontrado</div>';document.getElementById('mapResults').style.display='block';}}
function openNewCrag(){document.getElementById('ncNm').value='';document.getElementById('ncCoords').value='';document.getElementById('ncMsg').textContent='';document.getElementById('mapDiv').style.display='none';document.getElementById('mNC').classList.add('sh');}
async function svNewCrag(){const nm=document.getElementById('ncNm').value.trim(),raw=document.getElementById('ncCoords').value.trim(),msg=document.getElementById('ncMsg');
  if(!nm){msg.textContent='Pon un nombre';msg.style.color='var(--red)';return;}
  if(!raw){msg.textContent='Pega las coordenadas';msg.style.color='var(--red)';return;}
  let lat,lng;
  // Try to extract from Google Maps URL (@lat,lng)
  const urlMatch=raw.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
  if(urlMatch){lat=parseFloat(urlMatch[1]);lng=parseFloat(urlMatch[2]);}
  else{// Try direct coords: "43.27, -3.10" or "43.27 -3.10"
    const parts=raw.split(/[,\s]+/).filter(x=>x.length>0&&!isNaN(parseFloat(x)));
    if(parts.length>=2){lat=parseFloat(parts[0]);lng=parseFloat(parts[1]);}}
  if(isNaN(lat)||isNaN(lng)||lat<-90||lat>90||lng<-180||lng>180){
    msg.textContent='No he podido leer las coordenadas. Pega algo como: 43.270854, -3.102539';msg.style.color='var(--red)';return;}
  msg.textContent='Guardando...';msg.style.color='var(--green)';
  try{await saveCrag({name:nm,lat,lng});cm('mNC');document.getElementById('mapDiv').style.display='block';drM();}
  catch(e){msg.textContent='Error al guardar: '+e.message;msg.style.color='var(--red)';}}

// TRAINS
function drTr(){let tb='';[['plan','Programados'],['hist','Historial'],['meso','Mesociclo'],['prog','Progreso']].forEach(([k,lb])=>{tb+=`<button class="tb${tTb===k?' on':''}" onclick="tTb='${k}';drTr()">${lb}</button>`;});document.getElementById('tT').innerHTML=tb;
  document.getElementById('tH').style.display=tTb==='hist'?'block':'none';document.getElementById('tP').style.display=tTb==='plan'?'block':'none';document.getElementById('tProg').style.display=tTb==='prog'?'block':'none';document.getElementById('tMeso').style.display=tTb==='meso'?'block':'none';
  if(tTb==='hist'){drHist();}
  else if(tTb==='plan'){drPlan();}
  else if(tTb==='prog'){initDashDates();setTimeout(()=>drDash(),100);}
  else if(tTb==='meso'){drMeso();}}
let histMo='';
function drHist(){
  // Get unique months from Tr
  const mos=new Set();Tr.forEach(t=>{if(t.date)mos.add(t.date.substring(0,7));});
  const moArr=[...mos].sort().reverse();
  if(!histMo&&moArr.length)histMo=moArr[0];
  let h='<div style="display:flex;gap:6px;align-items:center;margin-bottom:10px"><select id="histMoSel" onchange="histMo=this.value;drHist()" style="flex:1;background:var(--bg3);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px;color:var(--text);font-size:13px;font-family:Nunito">';
  moArr.forEach(m=>{const d=new Date(m+'-01');const lb=d.toLocaleDateString('es-ES',{month:'long',year:'numeric'});
    h+=`<option value="${m}"${m===histMo?' selected':''}>${lb.charAt(0).toUpperCase()+lb.slice(1)}</option>`;});
  if(!moArr.length)h+='<option>Sin datos</option>';
  h+='</select></div>';
  const fl=Tr.filter(t=>t.date&&t.date.startsWith(histMo)).sort((a,b)=>b.date.localeCompare(a.date));
  h+=`<div style="font-size:11px;color:var(--text3);margin-bottom:6px">${fl.length} entrenos</div>`;
  fl.forEach(t=>{h+=`<div class="trn"><div style="display:flex;justify-content:space-between"><div class="tt2">${t.tipo}</div><div style="font-size:10px;color:var(--text3)">${new Date(t.date).toLocaleDateString('es-ES',{weekday:'short',day:'numeric',month:'short'})}</div></div><div class="td">${t.detail}</div></div>`;});
  if(!fl.length)h+='<div style="color:var(--text3);text-align:center;padding:20px">Sin entrenos este mes</div>';
  document.getElementById('tH').innerHTML=h;}
let woFolders=[],curFolder=null;
async function loadFolders(){if(!U)return;const q=await db.collection('users').doc(U.uid).collection('woFolders').get();woFolders=[];q.forEach(d=>{woFolders.push({id:d.id,...d.data()});});}
function drPlan(){
  let h='<div style="display:flex;gap:4px;margin-bottom:8px"><button class="btn bp" onclick="openWo()" style="flex:1;font-size:11px;padding:8px;border-radius:10px">+ Entreno</button><button class="btn bg2" onclick="newFolder()" style="width:auto;padding:8px 12px;font-size:11px;border-radius:10px;margin:0">üìÅ Carpeta</button></div>';
  h+='<input id="wQ" placeholder="üîç Buscar entreno..." oninput="drTr()" style="width:100%;background:var(--bg3);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:8px 14px;color:var(--text);font-size:12px;font-family:Nunito;outline:none;margin-bottom:8px">';
  if(newFolderMode){h+='<div style="display:flex;gap:4px;margin-bottom:8px"><input id="newFolderNm" placeholder="Nombre carpeta..." style="flex:1;background:var(--bg3);border:1px solid var(--rock);border-radius:10px;padding:8px;color:var(--text);font-size:12px;font-family:Nunito;outline:none"><button class="btn bp" onclick="doNewFolder()" style="width:auto;padding:8px 14px;font-size:11px;border-radius:10px;margin:0">‚úì</button><button class="btn bg2" onclick="newFolderMode=false;drTr()" style="width:auto;padding:8px 10px;font-size:11px;border-radius:10px;margin:0">‚úï</button></div>';}
  const q=(document.getElementById('wQ')||{}).value||'';
  // Show folders
  if(!curFolder){
    woFolders.forEach(f=>{const cnt=W.filter(w=>w.folder===f.id).length;
      h+=`<div style="background:var(--bg3);border-radius:12px;padding:12px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;gap:10px;border:1px solid rgba(255,255,255,.06)" onclick="curFolder='${f.id}';drTr()"><span style="font-size:24px">üìÅ</span><div style="flex:1"><div style="font-family:'Bebas Neue';font-size:16px;color:var(--rock)">${f.name}</div><div style="font-size:10px;color:var(--text3)">${cnt} entrenos</div></div><button style="background:none;border:none;color:var(--red);font-size:14px;cursor:pointer" onclick="event.stopPropagation();delFolder('${f.id}')">‚úï</button></div>`;});
    // Workouts without folder
    const loose=q?W.filter(w=>!w.folder&&(w.name||'').toLowerCase().includes(q.toLowerCase())):W.filter(w=>!w.folder);
    if(loose.length&&woFolders.length)h+='<div style="font-size:10px;color:var(--text3);margin:8px 0 4px;letter-spacing:1px;font-family:Bebas Neue">SIN CARPETA</div>';
    loose.forEach(w=>{h+=renderWoCard(w);});
  }else{
    const fold=woFolders.find(f=>f.id===curFolder);
    h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><button style="background:none;border:none;color:var(--text2);font-size:18px;cursor:pointer" onclick="curFolder=null;drTr()">‚óÄ</button><span style="font-family:'Bebas Neue';font-size:18px;color:var(--rock)">üìÅ ${fold?fold.name:'Carpeta'}</span></div>`;
    const fW=q?W.filter(w=>w.folder===curFolder&&(w.name||'').toLowerCase().includes(q.toLowerCase())):W.filter(w=>w.folder===curFolder);
    fW.forEach(w=>{h+=renderWoCard(w);});
    if(!fW.length)h+='<div style="color:var(--text3);text-align:center;padding:20px;font-size:12px">Carpeta vac√≠a ¬∑ Crea un entreno</div>';
  }
  document.getElementById('wL').innerHTML=h;}
function renderWoCard(w){
  let h=`<div class="wi"><button class="wi-del" onclick="delWo('${w.id}')">‚úï</button><div class="wit">${w.name}</div>${w.plannedDate?`<div class="wi-date">üìÖ ${new Date(w.plannedDate).toLocaleDateString('es-ES',{weekday:'short',day:'numeric',month:'short'})}</div>`:''}<div class="wis">`;
  (w.steps||[]).forEach((s,i)=>{const p=s;let d=p.nm||s.txt||'?';const pts=[];if(p.ag)pts.push(p.ag);if(p.mm)pts.push(p.mm+'mm');if(p.ang)pts.push(p.ang);if(p.kg>0)pts.push('+'+p.kg+'kg');
    if(p.modo==='time')pts.push(p.time+'s√ó'+((p.rep||1))+'√ó'+(p.ser||1));else if(p.reps)pts.push((p.reps)+'r√ó'+(p.ser||1));
    if(pts.length)d+=' ¬∑ '+pts.join(' ¬∑ ');
    h+=`<div class="wiss">${i+1}. ${d}</div>`;});
  h+=`</div><div style="display:flex;gap:4px;margin-top:6px;flex-wrap:wrap"><button class="sbb" style="font-size:11px;padding:6px 12px" onclick='execWo(${JSON.stringify(w).replace(/'/g,"&#39;")})'>‚ñ∂ Ejecutar</button><button class="sbb" style="font-size:11px;padding:6px 12px;background:var(--bg3);color:var(--text2)" onclick='editWo("${w.id}")'>‚úèÔ∏è Editar</button><button class="sbb" style="font-size:11px;padding:6px 12px;background:var(--blue)" onclick='shareWo("${w.id}")'>üë•</button><button class="sbb" style="font-size:11px;padding:6px 12px;background:var(--bg3);color:var(--text2)" onclick='moveWo("${w.id}")'>üìÅ</button></div></div>`;
  return h;}
let newFolderMode=false;
function newFolder(){newFolderMode=!newFolderMode;drTr();}
async function doNewFolder(){const inp=document.getElementById('newFolderNm');const nm=(inp?inp.value:'').trim();if(!nm){alert('Pon un nombre');return;}
  try{const ref=await db.collection('users').doc(U.uid).collection('woFolders').add({name:nm});
  woFolders.push({id:ref.id,name:nm});newFolderMode=false;drTr();}catch(e){alert('Error: '+e.message);}}
async function delFolder(id){if(!confirm('¬øEliminar carpeta? Los entrenos se quedan sueltos.'))return;
  await db.collection('users').doc(U.uid).collection('woFolders').doc(id).delete();
  woFolders=woFolders.filter(f=>f.id!==id);
  // Unassign workouts from this folder
  for(const w of W){if(w.folder===id){w.folder='';if(w.id)await db.collection('users').doc(U.uid).collection('workouts').doc(w.id).update({folder:''});}}
  if(curFolder===id)curFolder=null;drTr();}
async function moveWo(woId){
  let opts='<option value="">‚Äî Sin carpeta ‚Äî</option>';
  woFolders.forEach(f=>{opts+=`<option value="${f.id}">${f.name}</option>`;});
  const w=W.find(x=>x.id===woId);if(!w)return;
  const h=`<div style="padding:10px"><div style="font-family:'Bebas Neue';font-size:16px;color:var(--rock);margin-bottom:8px">Mover: ${w.name}</div><div class="fl"><label>Carpeta</label><select id="mvFolderSel" style="width:100%">${opts}</select></div><button class="btn bp" onclick="doMoveWo('${woId}')">Mover</button></div>`;
  const d=document.createElement('div');d.className='mbg sh';d.id='mMoveWo';d.innerHTML='<div class="mdl"><button class="mx" onclick="cm(\'mMoveWo\')">‚úï</button>'+h+'</div>';
  document.body.appendChild(d);
  if(w.folder)document.getElementById('mvFolderSel').value=w.folder;}
async function doMoveWo(woId){const fId=document.getElementById('mvFolderSel').value;
  const w=W.find(x=>x.id===woId);if(!w)return;
  w.folder=fId;await db.collection('users').doc(U.uid).collection('workouts').doc(woId).update({folder:fId||''});
  const el=document.getElementById('mMoveWo');if(el)el.remove();drTr();}
async function delWo(id){if(confirm('¬øEliminar?')){await delWorkout(id);drTr();}}
function editWo(id){const w=W.find(x=>x.id===id);if(!w)return;openWo(w);}
// Exercise templates
const TPLS=[{nm:'Suspensiones',ag:'Regleta',mm:20,kg:0,modo:'time',time:7,reps:0,rep:6,ser:4,desc:3,ds:180,ang:''},
{nm:'Bloqueos',ag:'Regleta',mm:20,kg:0,modo:'time',time:10,reps:0,rep:3,ser:3,desc:30,ds:180,ang:'90¬∞'},
{nm:'Campus',ag:'Regleta',mm:20,kg:0,modo:'reps',time:0,reps:1,rep:6,ser:4,desc:60,ds:180,ang:''},
{nm:'Dominadas',ag:'Barra',mm:0,kg:0,modo:'reps',time:0,reps:8,rep:0,ser:4,desc:0,ds:120,ang:''},
{nm:'Dominadas lastradas',ag:'Barra',mm:0,kg:10,modo:'reps',time:0,reps:5,rep:0,ser:4,desc:0,ds:180,ang:''},
{nm:'Flexiones',ag:'',mm:0,kg:0,modo:'reps',time:0,reps:15,rep:0,ser:3,desc:0,ds:90,ang:''},
{nm:'Abdominales',ag:'',mm:0,kg:0,modo:'reps',time:0,reps:20,rep:0,ser:3,desc:0,ds:60,ang:''},
{nm:'Pinza ext. mu√±eca',ag:'Pinza',mm:30,kg:5,modo:'time',time:10,reps:0,rep:6,ser:3,desc:5,ds:120,ang:''},
{nm:'Traves√≠a',ag:'',mm:0,kg:0,modo:'time',time:180,reps:0,rep:0,ser:3,desc:0,ds:180,ang:''},
{nm:'Personalizado',ag:'',mm:0,kg:0,modo:'reps',time:7,reps:10,rep:0,ser:3,desc:3,ds:120,ang:''}];
let editWoId=null;
function openWo(woToEdit){
  editWoId=null;wSt=[];document.getElementById('wNm').value='';document.getElementById('mW1Title').textContent='CREAR ENTRENO';
  document.getElementById('ejForm').style.display='none';document.getElementById('viaForm').style.display='none';
  let fh='<option value="">‚Äî Sin carpeta ‚Äî</option>';woFolders.forEach(f=>{fh+=`<option value="${f.id}"${curFolder===f.id?' selected':''}>${f.name}</option>`;});
  document.getElementById('wFolder').innerHTML=fh;
  // Populate grado selector for v√≠a form
  let gh='';G.forEach(g=>{gh+=`<option>${g}</option>`;});document.getElementById('vfGrado').innerHTML=gh;
  // Load templates (built-in + custom)
  let h='';TPLS.forEach((t,i)=>{h+=`<button class="ch" onclick="loadTpl(${i})">${t.nm}</button>`;});
  const cust=JSON.parse(localStorage.getItem('spCustomTpls')||'[]');
  cust.forEach((t,i)=>{h+=`<button class="ch" style="border-color:var(--green)" onclick="loadCustomTpl(${i})">${t.nm}</button>`;});
  document.getElementById('ejTpls').innerHTML=h;
  // If editing existing workout
  if(woToEdit){editWoId=woToEdit.id;document.getElementById('mW1Title').textContent='EDITAR ENTRENO';
    document.getElementById('wNm').value=woToEdit.name||'';
    if(woToEdit.folder)document.getElementById('wFolder').value=woToEdit.folder;
    wSt=[...(woToEdit.steps||[])];
  }
  rWS();document.getElementById('mW1').classList.add('sh');}
function showEjForm(){document.getElementById('ejForm').style.display='block';document.getElementById('viaForm').style.display='none';}
function showViaForm(){document.getElementById('ejForm').style.display='none';document.getElementById('viaForm').style.display='block';}
function loadTpl(i){const t=TPLS[i];document.getElementById('ejNm').value=t.nm;document.getElementById('ejAg').value=t.ag;document.getElementById('ejMm').value=t.mm||'';document.getElementById('ejAng').value=t.ang;document.getElementById('ejKg').value=t.kg;document.getElementById('ejModo').value=t.modo;document.getElementById('ejTime').value=t.time;document.getElementById('ejReps').value=t.reps;document.getElementById('ejRep').value=t.rep;document.getElementById('ejSer').value=t.ser;document.getElementById('ejDesc').value=t.desc;document.getElementById('ejDS').value=t.ds;ejModoChg();showEjForm();}
function loadCustomTpl(i){const cust=JSON.parse(localStorage.getItem('spCustomTpls')||'[]');if(cust[i])loadTplData(cust[i]);}
function loadTplData(t){document.getElementById('ejNm').value=t.nm;document.getElementById('ejAg').value=t.ag||'';document.getElementById('ejMm').value=t.mm||'';document.getElementById('ejAng').value=t.ang||'';document.getElementById('ejKg').value=t.kg||0;document.getElementById('ejModo').value=t.modo||'time';document.getElementById('ejTime').value=t.time||7;document.getElementById('ejReps').value=t.reps||0;document.getElementById('ejRep').value=t.rep||6;document.getElementById('ejSer').value=t.ser||4;document.getElementById('ejDesc').value=t.desc||3;document.getElementById('ejDS').value=t.ds||180;ejModoChg();showEjForm();}
function ejModoChg(){const m=document.getElementById('ejModo').value;document.getElementById('ejTimeF').style.display=m==='time'?'block':'none';document.getElementById('ejRepsF').style.display=m==='reps'?'block':'none';}
function rWS(){let h='';if(!wSt.length)h='<div style="color:var(--text3);font-size:11px;padding:6px">A√±ade ejercicios o v√≠as</div>';
  wSt.forEach((s,i)=>{
    const isVia=s.stepType==='via';
    const icon=isVia?'üßó':'üèã';
    h+=`<div class="ws" style="display:flex;align-items:center;gap:4px;${isVia?'border-left:3px solid var(--rock);':''}">`;
    h+=`<div style="display:flex;flex-direction:column;gap:2px"><button style="background:none;border:none;color:var(--text3);font-size:10px;cursor:pointer;padding:0" onclick="moveStep(${i},-1)">‚ñ≤</button><button style="background:none;border:none;color:var(--text3);font-size:10px;cursor:pointer;padding:0" onclick="moveStep(${i},1)">‚ñº</button></div>`;
    h+=`<div class="wn">${icon}${i+1}</div><div class="wd" style="flex:1">${s.txt||s.nm||'?'}</div><button class="wr" onclick="wSt.splice(${i},1);rWS()">‚úï</button></div>`;});
  document.getElementById('wS').innerHTML=h;}
function moveStep(i,dir){const ni=i+dir;if(ni<0||ni>=wSt.length)return;const tmp=wSt[i];wSt[i]=wSt[ni];wSt[ni]=tmp;rWS();}
function gv(id){const e=document.getElementById(id);return e?parseFloat(e.value)||0:0;}
function addEj(){const nm=document.getElementById('ejNm').value.trim();if(!nm){alert('Pon nombre');return;}
  const p={nm,ag:document.getElementById('ejAg').value,mm:gv('ejMm'),ang:document.getElementById('ejAng').value,kg:gv('ejKg'),modo:document.getElementById('ejModo').value,time:gv('ejTime'),reps:gv('ejReps'),rep:gv('ejRep'),ser:gv('ejSer'),desc:gv('ejDesc'),ds:gv('ejDS'),stepType:'exercise'};
  let txt=nm;const parts=[];if(p.ag)parts.push(p.ag);if(p.mm)parts.push(p.mm+'mm');if(p.ang)parts.push(p.ang);if(p.kg>0)parts.push('+'+p.kg+'kg');
  if(p.modo==='time'){if(p.ser>0&&p.rep>0)parts.push(p.ser+'x'+p.rep+' '+p.time+'s/'+p.desc+'s');else if(p.ser>0)parts.push(p.ser+'ser '+p.time+'s');else parts.push(p.time+'s');}else{if(p.ser>0&&p.reps>0)parts.push(p.ser+'x'+p.reps);else if(p.reps>0)parts.push(p.reps+'reps');}
  if(parts.length)txt+=' ¬∑ '+parts.join(' ¬∑ ');
  wSt.push({...p,txt});rWS();document.getElementById('ejForm').style.display='none';}
function addViaStep(){const grado=document.getElementById('vfGrado').value;const tipo=document.getElementById('vfTipo').value;
  const nombre=document.getElementById('vfNombre').value.trim();
  const txt=`${grado} ${tipo}${nombre?' ¬∑ '+nombre:''}`;
  wSt.push({stepType:'via',grado,tipo,nombre,txt});rWS();document.getElementById('vfNombre').value='';}
function saveCustomTpl(){const nm=document.getElementById('ejNm').value.trim();if(!nm){alert('Pon nombre');return;}
  const t={nm,ag:document.getElementById('ejAg').value,mm:gv('ejMm'),ang:document.getElementById('ejAng').value,kg:gv('ejKg'),modo:document.getElementById('ejModo').value,time:gv('ejTime'),reps:gv('ejReps'),rep:gv('ejRep'),ser:gv('ejSer'),desc:gv('ejDesc'),ds:gv('ejDS')};
  const cust=JSON.parse(localStorage.getItem('spCustomTpls')||'[]');cust.push(t);localStorage.setItem('spCustomTpls',JSON.stringify(cust));
  alert('Plantilla "'+nm+'" guardada');}
async function svW(){const n=(document.getElementById('wNm').value||'').trim();if(!n||!wSt.length){alert('Pon nombre y ejercicios');return;}
  const d={name:n,steps:[...wSt]};const fld=document.getElementById('wFolder').value;if(fld)d.folder=fld;
  if(editWoId){d.id=editWoId;await db.collection('users').doc(U.uid).collection('workouts').doc(editWoId).update(d);
    const wi=W.findIndex(x=>x.id===editWoId);if(wi>=0)W[wi]={...W[wi],...d};}
  else{await saveWorkout(d);}
  cm('mW1');tTb='plan';drTr();}

// EXECUTOR
let exSteps=[],exIdx=0,exTimerId=null,exSec=0,exTotalSec=0,exPaused=true,exWoName='',exWoSteps=[],exLandLock=null;
function execWo(w){exSteps=[];exWoName=w.name||'Entreno';exWoSteps=w.steps||[];
  // Try to lock landscape
  try{if(screen.orientation&&screen.orientation.lock)screen.orientation.lock('landscape').then(()=>{exLandLock=true;}).catch(()=>{});}catch(e){}
  (w.steps||[]).forEach((s,si)=>{const p=s.p||s;
    if(s.stepType==='via'){
      exSteps.push({label:`üßó ${s.grado} ${s.tipo}`,type:'via',dur:0,info:s.nombre||'V√≠a proyecto',grado:s.grado,tipo:s.tipo,nombre:s.nombre,stepIdx:si,detail:''});
      return;
    }
    const nm=p.nm||s.txt||s.nm||'Ejercicio';const ser=p.ser||1;const rep=p.rep||1;
    const det=[];if(p.ag)det.push(p.ag);if(p.mm)det.push(p.mm+'mm');if(p.ang)det.push(p.ang);if(p.kg>0)det.push('+'+p.kg+'kg');
    const detStr=det.length?det.join(' ¬∑ '):'';
    for(let si2=0;si2<ser;si2++){
      // Add preview step before first series of each exercise (except first exercise)
      if(si2===0&&exSteps.length>0){
        exSteps.push({label:'SIGUIENTE: '+nm,type:'preview',dur:0,info:detStr,detail:p.modo==='time'?`${ser} series √ó ${rep} reps √ó ${p.time}s`:`${ser} series √ó ${p.reps||0} reps`});}
      if(p.modo==='time'){for(let ri=0;ri<(rep||1);ri++){exSteps.push({label:nm,type:'work',dur:p.time||7,info:`Serie ${si2+1}/${ser} ¬∑ Rep ${ri+1}/${rep||1}`,detail:detStr});if(p.desc>0&&ri<(rep||1)-1)exSteps.push({label:'DESCANSO',type:'rest',dur:p.desc,info:'Entre reps',detail:''});}}
      else{exSteps.push({label:nm,type:'work',dur:0,info:`Serie ${si2+1}/${ser} ¬∑ ${p.reps||0} reps`,detail:detStr});}
      if(p.ds>0&&si2<ser-1)exSteps.push({label:'DESCANSO SERIE',type:'rest',dur:p.ds,info:'Descanso entre series',detail:''});}});
  if(!exSteps.length){alert('Entreno vac√≠o');return;}
  exIdx=0;exPaused=true;showExStep();document.getElementById('exPlayBtn').textContent='‚ñ∂ EMPEZAR';document.getElementById('mExec').style.display='block';}
function showExStep(){
  const ni=document.getElementById('exNextInfo');
  if(exIdx>=exSteps.length){document.getElementById('exTitle').textContent='¬°COMPLETADO!';document.getElementById('exStep').textContent='';document.getElementById('exTimer').textContent='‚úì';document.getElementById('exTimer').style.color='var(--green)';document.getElementById('exInfo').textContent='Buen entreno üí™';document.getElementById('exDetail').textContent='';ni.style.display='none';document.getElementById('exBar').style.width='100%';
  document.getElementById('exViaBtn').style.display='none';
  // Unlock orientation
  try{if(exLandLock&&screen.orientation&&screen.orientation.unlock)screen.orientation.unlock();}catch(e){}
  if(exWoName){saveTrain({date:new Date().toISOString().split('T')[0],tipo:'Entreno',detail:exWoName+' ('+exSteps.length+' pasos)'}).then(()=>{updStats();});}
  return;}
  const s=exSteps[exIdx];
  document.getElementById('exTitle').textContent=s.label;
  document.getElementById('exStep').textContent=`PASO ${exIdx+1} / ${exSteps.length}`;
  document.getElementById('exInfo').textContent=s.info||'';
  document.getElementById('exDetail').textContent=s.detail||'';
  const isRest=s.type==='rest';const isVia=s.type==='via';const isPreview=s.type==='preview';
  document.getElementById('exTimer').style.color=isRest?'var(--blue)':isVia?'var(--rock)':isPreview?'var(--yellow)':'var(--green)';
  document.getElementById('exBar').style.background=isRest?'var(--blue)':isVia?'var(--rock)':isPreview?'var(--yellow)':'var(--green)';
  document.getElementById('exViaBtn').style.display=isVia?'flex':'none';
  // Show next exercise info
  if(!isPreview){const nxt=exSteps.slice(exIdx+1).find(x=>x.type==='work'||x.type==='via');
    if(nxt){ni.textContent='Siguiente: '+nxt.label;ni.style.display='block';}else{ni.style.display='none';}}else{ni.style.display='none';}
  if(isPreview){exSec=0;document.getElementById('exTimer').textContent='üìã';document.getElementById('exBar').style.width=((exIdx+1)/exSteps.length*100)+'%';}
  else if(s.dur>0){exSec=s.dur;exTotalSec=s.dur;updExTimer();}
  else{exSec=0;document.getElementById('exTimer').textContent=isVia?'üßó':'‚Üí TAP';document.getElementById('exBar').style.width=((exIdx+1)/exSteps.length*100)+'%';}}
async function exViaDone(enc){const s=exSteps[exIdx];if(!s||s.type!=='via')return;
  // Auto-save route
  const route={date:new Date().toISOString().split('T')[0],grado:s.grado,tipo:s.tipo,lugar:'indoor',nombre:s.nombre||'',intento:1,enc:enc,sitio:'',notas:'Auto: '+exWoName,amigos:'',metros:0};
  await saveRoute(route);
  doAlert();nextEx();if(!exPaused&&exIdx<exSteps.length&&exSteps[exIdx].dur>0)runEx();}
function updExTimer(){const m=Math.floor(exSec/60),ss=exSec%60;document.getElementById('exTimer').textContent=exSec>=60?`${m}:${String(ss).padStart(2,'0')}`:exSec;document.getElementById('exBar').style.width=((exIdx+(1-exSec/exTotalSec))/exSteps.length*100)+'%';}
function toggleExec(){if(exIdx>=exSteps.length)return;exPaused=!exPaused;document.getElementById('exPlayBtn').textContent=exPaused?'‚ñ∂ SEGUIR':'‚è∏ PAUSA';
  if(!exPaused)runEx();}
function runEx(){if(exPaused||exIdx>=exSteps.length)return;const s=exSteps[exIdx];
  if(s.dur>0&&exSec>0){exTimerId=setTimeout(()=>{exSec--;updExTimer();if(exSec<=0){doAlert();nextEx();}else if(exSec<=3)doBeep();runEx();},1000);}
  else if(s.dur===0){/* manual - press skip or via buttons */}}
function nextEx(){exIdx++;showExStep();if(!exPaused&&exIdx<exSteps.length&&exSteps[exIdx].dur>0)runEx();}
function skipExec(){clearTimeout(exTimerId);doAlert();nextEx();if(!exPaused&&exIdx<exSteps.length&&exSteps[exIdx].dur>0)runEx();}
function stopExec(){clearTimeout(exTimerId);exPaused=true;document.getElementById('mExec').style.display='none';
  try{if(exLandLock&&screen.orientation&&screen.orientation.unlock)screen.orientation.unlock();}catch(e){}}
function doAlert(){const s=getSettings();if(s.vibra)try{navigator.vibrate&&navigator.vibrate([200,100,200]);}catch(e){}if(s.sound)try{const ac=new(window.AudioContext||window.webkitAudioContext)();const o=ac.createOscillator();o.type='sine';o.frequency.value=880;o.connect(ac.destination);o.start();setTimeout(()=>o.stop(),200);}catch(e){}}
function doBeep(){if(!document.getElementById('exSound').checked)return;try{navigator.vibrate&&navigator.vibrate(100);}catch(e){}try{const ac=new(window.AudioContext||window.webkitAudioContext)();const o=ac.createOscillator();o.type='sine';o.frequency.value=660;o.connect(ac.destination);o.start();setTimeout(()=>o.stop(),100);}catch(e){}}

// FRIENDS
async function drFr(){let h='';if(!friends.length)h='<div style="color:var(--text3);font-size:11px;text-align:center;padding:16px">A√±ade amigos con su c√≥digo # o email</div>';
  for(const f of friends){const q=await db.collection('users').where('email','==',f.email).get();let name=f.email,photo='',code='';
    if(!q.empty){const ud=q.docs[0].data();name=ud.name||f.email;photo=ud.photo||'';code=ud.code?'#'+ud.code:'';}
    f.name=name;f.photo=photo;f.code=code;    h+=`<div class="fr-card"><img class="fr-pic" src="${photo||'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><circle cx=%2212%22 cy=%228%22 r=%224%22 fill=%22%238a9bb0%22/><path d=%22M4 20c0-4 4-7 8-7s8 3 8 7%22 fill=%22%238a9bb0%22/></svg>'}" onclick="viewFr('${f.email}')"><div class="fr-info" onclick="viewFr('${f.email}')"><div class="fr-name">${name} <span style="font-size:9px;color:var(--rock)">${code}</span></div></div><button style="background:none;border:none;color:var(--blue);font-size:16px;cursor:pointer;padding:4px" onclick="event.stopPropagation();openChatByEmail('${f.email}')">üí¨</button><button class="fr-rm" onclick="event.stopPropagation();rmFr('${f.id}')">‚úï</button></div>`;}
  document.getElementById('frList').innerHTML=h;document.getElementById('frView').style.display='none';}
async function openChatByEmail(email){const q=await db.collection('users').where('email','==',email).get();if(q.empty)return;const fd=q.docs[0].data();openChat(q.docs[0].id,(fd.name||email).replace(/'/g,''));}
async function addFriend(){const raw=document.getElementById('frCode').value.trim(),msg=document.getElementById('frMsg');
  if(!raw){msg.textContent='Pon c√≥digo o email';msg.style.color='var(--red)';return;}
  let q;
  if(raw.startsWith('#')||/^\d+$/.test(raw)){
    const code=parseInt(raw.replace('#',''));
    q=await db.collection('users').where('code','==',code).get();
  }else{q=await db.collection('users').where('email','==',raw.toLowerCase()).get();}
  if(q.empty){msg.textContent='No encontrado';msg.style.color='var(--yellow)';return;}
  const fDoc=q.docs[0],fd=fDoc.data();
  if(fDoc.id===U.uid){msg.textContent='Ese eres t√∫';msg.style.color='var(--red)';return;}
  if(friends.some(f=>f.email===fd.email)){msg.textContent='Ya es tu amigo';msg.style.color='var(--yellow)';return;}
  await db.collection('users').doc(U.uid).collection('friends').add({email:fd.email});friends.push({email:fd.email});
  document.getElementById('frCode').value='';msg.textContent=(fd.name||fd.email)+' a√±adido ‚úì';msg.style.color='var(--green)';drFr();}
async function rmFr(id){await db.collection('users').doc(U.uid).collection('friends').doc(id).delete();friends=friends.filter(f=>f.id!==id);drFr();}
async function viewFr(email){const q=await db.collection('users').where('email','==',email).get();if(q.empty)return;
  const fuid=q.docs[0].id,fd=q.docs[0].data();document.getElementById('frViewTitle').textContent='V√çAS DE '+(fd.name||email).toUpperCase();
  const rs=await db.collection('users').doc(fuid).collection('routes').orderBy('date','desc').limit(30).get();let h='';
  rs.forEach(d=>{h+=vc({id:d.id,...d.data()},false);});
  document.getElementById('frRoutes').innerHTML=h||'<div style="color:var(--text3);font-size:11px;padding:8px">Sin v√≠as</div>';document.getElementById('frView').style.display='block';}

// MESOCICLOS
const MESO_COLORS=[{name:'Base aer√≥bica',color:'#ffe66d'},{name:'Fuerza resistencia',color:'#4ecdc4'},{name:'Fuerza m√°xima',color:'#ff6b6b'},{name:'Potencia',color:'#a78bfa'},{name:'Descarga',color:'#4a9eff'},{name:'Personalizado',color:'#8a9bb0'}];
let msFases=[];
function drMeso(){let h='';if(!mesos.length)h='<div style="color:var(--text3);font-size:11px;text-align:center;padding:16px">Sin mesociclos</div>';
  mesos.forEach(m=>{h+=`<div class="meso-card"><button class="meso-del" onclick="delMeso('${m.id}')">‚úï</button><div style="font-family:'Bebas Neue';font-size:16px;color:var(--rock)">${m.name}</div><div style="font-size:10px;color:var(--text3);margin-bottom:6px">Inicio: ${new Date(m.start).toLocaleDateString('es-ES',{day:'numeric',month:'short'})}</div>`;
    (m.fases||[]).forEach(f=>{h+=`<div class="meso-fase"><div class="meso-dot" style="background:${f.color}"></div><div class="meso-info"><b>${f.name}</b> ¬∑ ${f.weeks} sem</div></div>`;});
    h+=`</div>`;});
  document.getElementById('mesoList').innerHTML=h;}
function openMeso(){msFases=[];
  // If there's a previous meso, offer to copy
  if(mesos.length){const last=mesos[mesos.length-1];
    document.getElementById('msPrev').style.display='block';
    document.getElementById('msPrev').innerHTML=`<button class="btn bg2" style="font-size:11px" onclick="copyLastMeso()">üìã Copiar de "${last.name}"</button>`;}
  else{document.getElementById('msPrev').style.display='none';}
  document.getElementById('msNm').value='';document.getElementById('msStart').value=new Date().toISOString().split('T')[0];
  rMsFases();document.getElementById('mMeso').classList.add('sh');}
function copyLastMeso(){const last=mesos[mesos.length-1];if(!last)return;msFases=(last.fases||[]).map(f=>({...f}));rMsFases();}
function addFase(){msFases.push({name:MESO_COLORS[0].name,color:MESO_COLORS[0].color,weeks:4});rMsFases();}
function rMsFases(){let h='';msFases.forEach((f,i)=>{
    let opts='';MESO_COLORS.forEach(c=>{opts+=`<option value="${c.name}" ${f.name===c.name?'selected':''}>${c.name}</option>`;});
    h+=`<div class="meso-fase"><div class="meso-dot" style="background:${f.color}"></div><select style="flex:1;background:var(--bg);border:1px solid rgba(255,255,255,.08);border-radius:6px;padding:4px;color:var(--text);font-size:11px;font-family:Nunito" onchange="msFases[${i}].name=this.value;const c=MESO_COLORS.find(x=>x.name===this.value);if(c)msFases[${i}].color=c.color;rMsFases()">${opts}</select><input type="number" value="${f.weeks}" min="1" max="8" style="width:40px;background:var(--bg);border:1px solid rgba(255,255,255,.08);border-radius:6px;padding:4px;color:var(--text);font-size:11px;text-align:center;font-family:Nunito" onchange="msFases[${i}].weeks=parseInt(this.value)||1;rMsFases()"><span style="font-size:9px;color:var(--text3)">sem</span><button class="meso-rm" onclick="msFases.splice(${i},1);rMsFases()">‚úï</button></div>`;});
  if(!msFases.length)h='<div style="font-size:10px;color:var(--text3);padding:4px">A√±ade fases</div>';
  document.getElementById('msFases').innerHTML=h;}
async function svMeso(){const nm=document.getElementById('msNm').value.trim(),start=document.getElementById('msStart').value;
  if(!nm||!start||!msFases.length){alert('Pon nombre, fecha y al menos una fase');return;}
  const data={name:nm,start,fases:msFases.map(f=>({name:f.name,color:f.color,weeks:f.weeks}))};
  const ref=await db.collection('users').doc(U.uid).collection('mesos').add(data);data.id=ref.id;mesos.push(data);
  cm('mMeso');tTb='meso';drTr();}
async function delMeso(id){if(!confirm('¬øEliminar mesociclo?'))return;await db.collection('users').doc(U.uid).collection('mesos').doc(id).delete();mesos=mesos.filter(m=>m.id!==id);drMeso();}
// Get mesociclo color for a date
function getMesoColor(dateStr){for(const m of mesos){let d=new Date(m.start);for(const f of(m.fases||[])){for(let w=0;w<f.weeks;w++){const ws=d.toISOString().split('T')[0];const we=new Date(d);we.setDate(we.getDate()+6);const weS=we.toISOString().split('T')[0];if(dateStr>=ws&&dateStr<=weS)return f.color;d.setDate(d.getDate()+7);}}}return null;}

// DASHBOARD EXPLORER - fully customizable
function updFilters(){const src=document.getElementById('grSrc').value,x=document.getElementById('grX').value;
  const filt=document.getElementById('grFilt');filt.innerHTML='<option value="">‚Äî Sin filtro ‚Äî</option>';
  if(src==='vias'||src==='todo'){
    if(x!=='lugar'){const locs=new Set();R.forEach(r=>{if(r.sitio)locs.add(r.sitio);});locs.forEach(l=>filt.innerHTML+=`<option value="lugar:${l}">üìç ${l}</option>`);}
    if(x!=='grado')G.forEach(g=>filt.innerHTML+=`<option value="grado:${g}">üèî ${g}</option>`);
    filt.innerHTML+='<option value="enc:1">‚úì Solo encadenes</option><option value="tipo:roca">üèî Solo roca</option><option value="tipo:roco">üè¢ Solo roco</option>';
    if(x!=='compa'){const cps=new Set();R.forEach(r=>{if(r.amigos)(r.amigos).split(/[,;]+/).forEach(a=>{a=a.trim();if(a)cps.add(a);});});cps.forEach(c=>filt.innerHTML+=`<option value="compa:${c}">üë• ${c}</option>`);}}
  if(src==='entrenos'||src==='todo'){
    const ejs=new Set();W.forEach(w=>(w.steps||[]).forEach(s=>{const nm=s.nm||s.txt||'';if(nm)ejs.add(nm);}));
    ejs.forEach(e=>filt.innerHTML+=`<option value="ej:${e}">üèã ${e}</option>`);
    const ags=new Set();W.forEach(w=>(w.steps||[]).forEach(s=>{if(s.ag)ags.add(s.ag);}));
    ags.forEach(a=>filt.innerHTML+=`<option value="ag:${a}">ü§è ${a}</option>`);
    const mms=new Set();W.forEach(w=>(w.steps||[]).forEach(s=>{if(s.mm)mms.add(s.mm+'mm');}));
    [...mms].sort().forEach(m=>filt.innerHTML+=`<option value="mm:${m}">üìè ${m}</option>`);}}
function drDash(){const from=document.getElementById('grFrom').value,to=document.getElementById('grTo').value;
  const xAxis=document.getElementById('grX').value,yAxis=document.getElementById('grY').value;
  const src=document.getElementById('grSrc').value,filt=document.getElementById('grFilt').value;
  const acum=document.getElementById('grMode').value==='acum';
  const cv=document.getElementById('cDash');if(!cv)return;const ctx=cv.getContext('2d');cv.width=cv.offsetWidth*2;cv.height=400;ctx.scale(2,2);const w=cv.offsetWidth,h=200;ctx.clearRect(0,0,w,h);
  let vias=src!=='entrenos'?R.filter(r=>r.date>=from&&r.date<=to):[];
  let steps=[];if(src!=='vias'){W.forEach(wk=>{const d=wk.plannedDate||'';if(d>=from&&d<=to)(wk.steps||[]).forEach(s=>{steps.push({...s,date:d});});});}
  // Also use trains for dias_ent
  const trains=Tr.filter(t=>t.date>=from&&t.date<=to);
  if(filt){const[fk,fv]=filt.split(':');
    if(fk==='lugar')vias=vias.filter(r=>r.sitio===fv);
    if(fk==='grado')vias=vias.filter(r=>r.grado===fv);
    if(fk==='enc')vias=vias.filter(r=>r.enc);
    if(fk==='tipo'){if(fv==='roca')vias=vias.filter(r=>r.lugar==='roca');if(fv==='roco')vias=vias.filter(r=>r.lugar==='indoor'||r.lugar==='roco');}
    if(fk==='compa')vias=vias.filter(r=>(r.amigos||'').includes(fv));
    if(fk==='ej')steps=steps.filter(s=>(s.nm||s.txt||'')===fv);
    if(fk==='ag')steps=steps.filter(s=>s.ag===fv);
    if(fk==='mm')steps=steps.filter(s=>s.mm+''+'mm'===fv);}
  const groups={};
  const addToGroup=(key,item,isTrain)=>{if(!groups[key])groups[key]={vias:[],steps:[],trains:[]};if(isTrain)groups[key].steps.push(item);else groups[key].vias.push(item);};
  const addTrainGroup=(key,t)=>{if(!groups[key])groups[key]={vias:[],steps:[],trains:[]};groups[key].trains.push(t);};
  const getXKey=(date,item,isTrain)=>{
    if(xAxis==='mes')return date.substring(0,7);
    if(xAxis==='semana'){const d=new Date(date);const wk=Math.ceil(d.getDate()/7);return date.substring(0,7)+'-S'+wk;}
    if(xAxis==='dia')return date;
    if(xAxis==='lugar')return isTrain?'Entreno':(item.sitio||'?');
    if(xAxis==='compa'){if(isTrain)return 'Entreno';const ams=(item.amigos||'').split(/[,;]+/).map(a=>a.trim()).filter(Boolean);return ams.length?ams[0]:'Solo';}
    if(xAxis==='grado')return isTrain?'Entreno':(item.grado||'?');
    if(xAxis==='tipo')return isTrain?(item.nm||item.txt||'?'):(item.tipo||'?');
    if(xAxis==='agarre')return isTrain?(item.ag||'?'):'V√≠a';
    if(xAxis==='ejercicio')return isTrain?(item.nm||item.txt||'?'):'V√≠a';
    return '?';};
  vias.forEach(r=>addToGroup(getXKey(r.date,r,false),r,false));
  steps.forEach(s=>addToGroup(getXKey(s.date,s,true),s,true));
  trains.forEach(t=>{const k=xAxis==='mes'?t.date.substring(0,7):xAxis==='semana'?t.date.substring(0,7)+'-S'+Math.ceil(new Date(t.date).getDate()/7):t.date;addTrainGroup(k,t);});
  const data=[];const sortable=xAxis==='mes'||xAxis==='semana'||xAxis==='dia';
  let entries=Object.entries(groups);if(sortable)entries.sort((a,b)=>a[0].localeCompare(b[0]));else entries.sort((a,b)=>(b[1].vias.length+b[1].steps.length)-(a[1].vias.length+a[1].steps.length));
  entries.slice(0,30).forEach(([key,g])=>{let val=0;
    if(yAxis==='count')val=g.vias.length+g.steps.length;
    else if(yAxis==='enc')val=g.vias.filter(r=>r.enc).length;
    else if(yAxis==='metros')val=g.vias.reduce((a,r)=>a+(r.metros||0),0);
    else if(yAxis==='lastre'){const kgs=[...g.steps.map(s=>s.kg||0)];val=kgs.length?Math.max(...kgs):0;}
    else if(yAxis==='regleta'){const mms=g.steps.map(s=>s.mm).filter(m=>m>0);val=mms.length?Math.min(...mms):0;}
    else if(yAxis==='grado_max'){const gs=g.vias.map(r=>G.indexOf(r.grado)).filter(i=>i>=0);val=gs.length?Math.max(...gs):0;}
    else if(yAxis==='intentos'){const ints=g.vias.map(r=>r.intento||1);val=ints.length?Math.round(ints.reduce((a,b)=>a+b,0)/ints.length*10)/10:0;}
    else if(yAxis==='dias_ent'){const ds=new Set();g.vias.forEach(r=>ds.add(r.date));g.trains.forEach(t=>ds.add(t.date));val=ds.size;}
    else if(yAxis==='series')val=g.steps.reduce((a,s)=>a+(s.ser||0),0);
    else if(yAxis==='reps')val=g.steps.reduce((a,s)=>a+(s.ser||1)*(s.reps||s.rep||0),0);
    else if(yAxis==='tiempo')val=Math.round(g.steps.reduce((a,s)=>a+((s.ser||1)*(s.rep||1)*(s.time||0)+(s.ser||1)*(s.ds||0))/60,0));
    const lb=key.length>7&&(xAxis==='mes'||xAxis==='semana')?key.slice(5):key;
    data.push([lb.length>12?lb.slice(0,12)+'‚Ä¶':lb,val]);});
  // Acumulativo
  if(acum&&data.length){let cum=0;data.forEach(d=>{if(typeof d[1]==='number'){cum+=d[1];d[1]=cum;}});}
  if(!data.length){ctx.fillStyle='#5a6a7a';ctx.font='12px Nunito';ctx.textAlign='center';ctx.fillText('Sin datos en este rango',w/2,h/2);document.getElementById('dashInfo').textContent='';return;}
  const isNumeric=data.every(d=>typeof d[1]==='number');
  if(isNumeric&&(sortable||data.length<=5))drawLine(ctx,w,h,data);
  else if(isNumeric)drawBars(ctx,w,h,data);
  else drawLabels(ctx,w,h,data);
  if(isNumeric){const vals=data.map(d=>d[1]).filter(v=>v>0);if(vals.length){const sum=acum?vals[vals.length-1]:vals.reduce((a,b)=>a+b,0);document.getElementById('dashInfo').textContent=`Total: ${sum} ¬∑ Media: ${Math.round((acum?sum/vals.length:sum/vals.length)*10)/10} ¬∑ M√°x: ${Math.max(...vals)}`;}else document.getElementById('dashInfo').textContent='';}else document.getElementById('dashInfo').textContent='';}
let savedGraphList=JSON.parse(localStorage.getItem('spSavedGraphs')||'[]');
function saveGraph(){const nm=prompt('Nombre del gr√°fico:');if(!nm)return;
  const cfg={name:nm,x:document.getElementById('grX').value,y:document.getElementById('grY').value,src:document.getElementById('grSrc').value,filt:document.getElementById('grFilt').value,mode:document.getElementById('grMode').value};
  savedGraphList.push(cfg);localStorage.setItem('spSavedGraphs',JSON.stringify(savedGraphList));drSavedGraphs();}
function drSavedGraphs(){let h='';savedGraphList.forEach((g,i)=>{
  h+=`<button class="ch" style="position:relative;padding-right:18px" onclick="loadGraph(${i})">${g.name}<span style="position:absolute;right:3px;top:2px;font-size:9px;color:var(--red);cursor:pointer" onclick="event.stopPropagation();savedGraphList.splice(${i},1);localStorage.setItem('spSavedGraphs',JSON.stringify(savedGraphList));drSavedGraphs()">‚úï</span></button>`;});
  document.getElementById('savedGraphs').innerHTML=h;}
function loadGraph(i){const g=savedGraphList[i];if(!g)return;
  document.getElementById('grX').value=g.x;document.getElementById('grY').value=g.y;
  document.getElementById('grSrc').value=g.src;document.getElementById('grMode').value=g.mode||'normal';
  updFilters();if(g.filt)document.getElementById('grFilt').value=g.filt;drDash();}
function initDashDates(){const td=new Date(),y1=new Date(td);y1.setFullYear(y1.getFullYear()-1);document.getElementById('grFrom').value=y1.toISOString().split('T')[0];document.getElementById('grTo').value=td.toISOString().split('T')[0];
  let h='';[['1m','1 mes'],['3m','3 meses'],['6m','6 meses'],['1y','1 a√±o'],['all','Todo']].forEach(([k,lb])=>{h+=`<button class="ch" onclick="setDashPer('${k}')">${lb}</button>`;});document.getElementById('grPresets').innerHTML=h;updFilters();drSavedGraphs();}
function setDashPer(p){const td=new Date();document.getElementById('grTo').value=td.toISOString().split('T')[0];let f=new Date(td);if(p==='1m')f.setMonth(f.getMonth()-1);else if(p==='3m')f.setMonth(f.getMonth()-3);else if(p==='6m')f.setMonth(f.getMonth()-6);else if(p==='1y')f.setFullYear(f.getFullYear()-1);else f=new Date('2020-01-01');document.getElementById('grFrom').value=f.toISOString().split('T')[0];}
function groupByMonth(arr){const m={};arr.forEach(x=>{const k=(x.date||'').substring(0,7);if(k){if(!m[k])m[k]=[];m[k].push(x);}});return Object.entries(m).sort((a,b)=>a[0].localeCompare(b[0]));}
function drawLine(ctx,w,h,data){const vals=data.map(d=>d[1]);const mx=Math.max(...vals),mn=Math.min(...vals);const range=mx-mn||1;
  const pad={t:20,b:28,l:32,r:10},gw=w-pad.l-pad.r,gh=h-pad.t-pad.b;
  ctx.strokeStyle='rgba(255,255,255,.06)';ctx.lineWidth=.5;for(let i=0;i<=3;i++){const y=pad.t+gh*i/3;ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(w-pad.r,y);ctx.stroke();ctx.fillStyle='#5a6a7a';ctx.font='8px Nunito';ctx.textAlign='right';ctx.fillText(Math.round(mx-range*i/3),pad.l-3,y+3);}
  ctx.beginPath();ctx.strokeStyle='#d4a574';ctx.lineWidth=2.5;ctx.lineJoin='round';
  data.forEach(([,v],i)=>{const x=pad.l+i*(gw/Math.max(data.length-1,1));const y=pad.t+gh-(v-mn)/range*gh;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();
  data.forEach(([lb,v],i)=>{const x=pad.l+i*(gw/Math.max(data.length-1,1));const y=pad.t+gh-(v-mn)/range*gh;ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fillStyle='#d4a574';ctx.fill();ctx.fillStyle='#e8e0d8';ctx.font='bold 9px Nunito';ctx.textAlign='center';ctx.fillText(v,x,y-10);ctx.fillStyle='#5a6a7a';ctx.font='7px Nunito';ctx.fillText(lb,x,h-3);});}
function drawBars(ctx,w,h,data){const vals=data.map(d=>d[1]);const mx=Math.max(...vals,1);
  const pad={t:15,b:32,l:10,r:10},gw=w-pad.l-pad.r,gh=h-pad.t-pad.b;const bw=Math.min(gw/data.length-3,36);
  const colors=['#d4a574','#4ecdc4','#ffe66d','#a78bfa','#4a9eff','#ff6b6b','#8a9bb0','#e8e0d8','#4ecdc4','#d4a574'];
  data.forEach(([lb,v],i)=>{const x=pad.l+(gw/data.length)*i+(gw/data.length-bw)/2;const bh=Math.max((v/mx)*gh,2);const y=pad.t+gh-bh;
    ctx.fillStyle=colors[i%colors.length];ctx.beginPath();ctx.roundRect(x,y,bw,bh,3);ctx.fill();
    ctx.fillStyle='#e8e0d8';ctx.font='bold 9px Nunito';ctx.textAlign='center';ctx.fillText(v,x+bw/2,y-4);
    ctx.fillStyle='#8a9bb0';ctx.font='7px Nunito';ctx.save();ctx.translate(x+bw/2,h-2);if(lb.length>5)ctx.rotate(-0.5);ctx.fillText(lb.length>10?lb.slice(0,10)+'‚Ä¶':lb,0,0);ctx.restore();});}
function drawLabels(ctx,w,h,data){const pad={t:20,b:25,l:10,r:10},gw=w-pad.l-pad.r;
  data.forEach(([lb,v],i)=>{const x=pad.l+i*(gw/Math.max(data.length-1,1));ctx.fillStyle='#d4a574';ctx.font='bold 14px Bebas Neue';ctx.textAlign='center';ctx.fillText(v,x,h/2);ctx.fillStyle='#5a6a7a';ctx.font='8px Nunito';ctx.fillText(lb,x,h/2+16);});}
// ‚îÄ‚îÄ BOLT BLE (disabled - saved separately in Bolt.ino) ‚îÄ‚îÄ
</script>
<script>if('serviceWorker' in navigator)navigator.serviceWorker.register('./sw.js').catch(()=>{});</script>
</body>
</html>
